generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id             String     @id @default(uuid())
  code           String     @unique
  name           String
  type           OrgType
  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String     @default("USA")
  phone          String?
  email          String?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  coils          Coil[]
  documents      Document[]
  heats          Heat[]
  locations      Location[]
  ordersAsBuyer  Order[]    @relation("BuyerOrders")
  ordersAsSeller Order[]    @relation("SellerOrders")
  rfqs           RFQ[]      @relation("CustomerRFQs")
  users          User[]
  pricingTier    CustomerPricingTier? @relation("CustomerPricingTier")
  dropTags       DropTag[]  @relation("DropTagCustomer")
  tagRequirements CustomerTagRequirement[] @relation("CustomerTagRequirements")
  partners       Partner[]  @relation("PartnerOrganization")
  preferences    CustomerPreference?  @relation("CustomerPreferences")
}

// Customer preferences — per-customer defaults for orders, shipping, specs, packaging
model CustomerPreference {
  id                   String    @id @default(uuid())
  customerId           String    @unique
  customer             Organization @relation("CustomerPreferences", fields: [customerId], references: [id])

  // Location & Shipping
  preferredBranch      String?   // branch code e.g. JACKSON
  preferredShipMethod  String?   // DELIVERY, WILL_CALL, SHIP_CARRIER, LTL, FLATBED
  defaultDivision      String?   // METALS, PLASTICS, SUPPLIES
  preferredCarrier     String?   // e.g. XPO, FedEx Freight
  freightTerms         String?   // FOB_ORIGIN, FOB_DEST, PREPAID, COLLECT
  deliveryWindow       String?   // e.g. "Tue/Thu 7am-2pm"
  shipToAddress        Json?     // { label, address, city, state, zip }

  // Priority & Order Rules
  defaultPriority      String    @default("STANDARD") // STANDARD, RUSH, HOT, EMERGENCY
  rushDefault           Boolean  @default(false)
  defaultOwnership     String    @default("HOUSE")     // HOUSE, CUSTOMER_MATERIAL
  requirePONumber      Boolean   @default(false)
  autoApplyContract    Boolean   @default(true)
  autoApproveOrders    Boolean   @default(false)
  minOrderQty          Decimal?
  minOrderValue        Decimal?

  // Pricing
  pricingTier          String?   // A, B, C, D
  discountPct          Decimal?  // default discount %
  fuelSurchargeExempt  Boolean   @default(false)
  paymentTerms         String?   // Net 30, Net 60, COD
  creditLimit          Decimal?
  contractNotes        String?

  // Material Specs
  tolerancePreset          String    @default("STANDARD")
  // Thickness tolerances
  thkTolerancePlus         Decimal   @default(0.010)
  thkToleranceMinus        Decimal   @default(0.010)
  // Length tolerances
  lenTolerancePlus         Decimal   @default(0.125)
  lenToleranceMinus        Decimal   @default(0.000)
  // Width tolerances
  widTolerancePlus         Decimal   @default(0.063)
  widToleranceMinus        Decimal   @default(0.031)
  approvedGrades           Json?     // ["A36", "A572-50", ...]
  surfaceFinish        String?   // MILL, PICKLED, OILED, BLASTED
  specialSpecs         String?   // free-text spec notes

  // Certifications
  certRequirements     Json?     // ["MTR", "COC", "FIRST_ARTICLE", ...]
  autoSendMTR          Boolean   @default(false)
  autoSendInvoice      Boolean   @default(false)
  mtrEmail             String?
  invoiceEmail         String?

  // Packaging & Labeling
  bundleMaxWeight      Decimal?  // max lbs per bundle
  bundleMaxPieces      Int?
  packagingType        String?   // BANDED, CRATED, PALLETIZED, LOOSE
  labelTemplate        String?   // customer-specific tag template code
  packagingNotes       String?

  // Notes
  specialInstructions  String?
  internalNotes        String?

  // Audit
  updatedBy            String?
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  @@index([customerId])
}

model User {
  id               String               @id @default(uuid())
  email            String               @unique
  passwordHash     String
  firstName        String
  lastName         String
  role             UserRole
  organizationId   String
  homeLocationId   String?
  title            String?
  phone            String?
  avatarUrl        String?
  lastLoginAt      DateTime?
  mfaEnabled       Boolean              @default(false)
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  createdCoils     Coil[]               @relation("CoilCreator")
  createdHeats     Heat[]               @relation("HeatCreator")
  assignedJobs     Job[]                @relation("JobAssignee")
  createdJobs      Job[]                @relation("JobCreator")
  movements        MaterialMovement[]
  orders           Order[]              @relation("OrderCreator")
  qcHolds          QCHold[]             @relation("HoldBy")
  resolvedHolds    QCHold[]             @relation("ResolvedBy")
  approvedTests    TestResult[]         @relation("ApprovedBy")
  testResults      TestResult[]         @relation("TestedBy")
  organization     Organization         @relation(fields: [organizationId], references: [id])
  homeLocation     Location?            @relation("UserHomeLocation", fields: [homeLocationId], references: [id])
  userRoles        UserRoleAssignment[]
  userLocations    UserLocation[]
  userDivisions    UserDivision[]
  auditLogs        AuditLog[]           @relation("AuditActor")
  approvalRequests ApprovalRequest[]    @relation("ApprovalRequester")
  approvalsMade    ApprovalDecision[]   @relation("ApprovalDecider")
  operator         Operator?
}

// Role definition with permissions
model Role {
  id          String               @id @default(uuid())
  name        String               @unique
  displayName String
  description String?
  permissions Json // Array of permission strings
  isSystem    Boolean              @default(false)
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  userRoles   UserRoleAssignment[]
}

// Many-to-many: User <-> Role
model UserRoleAssignment {
  id        String    @id @default(uuid())
  userId    String
  roleId    String
  grantedAt DateTime  @default(now())
  grantedBy String?
  expiresAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// User location assignments for ABAC scoping
model UserLocation {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
}

// User division assignments for ABAC scoping
model UserDivision {
  id         String   @id @default(uuid())
  userId     String
  divisionId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  division   Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([userId, divisionId])
  @@index([userId])
  @@index([divisionId])
}

// Division model for organizational structure
model Division {
  id             String         @id @default(uuid())
  code           String         @unique
  name           String
  organizationId String
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  userDivisions  UserDivision[]
}

// Approval workflow tracking
model ApprovalRequest {
  id            String             @id @default(uuid())
  tenantId      String
  requestType   String // e.g., "QUOTE_DISCOUNT", "INVENTORY_ADJUST"
  resourceType  String
  resourceId    String
  requesterId   String
  status        ApprovalStatus     @default(PENDING)
  requestData   Json
  justification String?
  expiresAt     DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  requester     User               @relation("ApprovalRequester", fields: [requesterId], references: [id])
  decisions     ApprovalDecision[]

  @@index([tenantId, status])
  @@index([requesterId])
}

model ApprovalDecision {
  id        String          @id @default(uuid())
  requestId String
  deciderId String
  decision  DecisionType
  comments  String?
  createdAt DateTime        @default(now())
  request   ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  decider   User            @relation("ApprovalDecider", fields: [deciderId], references: [id])

  @@index([requestId])
}

// Audit log for security events
model AuditLog {
  id            String   @id @default(uuid())
  tenantId      String?
  category      String // AUTH, AUTHZ, DATA, FINANCIAL, WORKFLOW, SYSTEM
  eventType     String
  severity      String   @default("INFO")
  userId        String?
  targetUserId  String?
  resourceType  String?
  resourceId    String?
  action        String?
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  correlationId String?
  requestPath   String?
  requestMethod String?
  responseCode  Int?
  durationMs    Int?
  details       Json?
  fieldChanges  Json?
  timestamp     DateTime @default(now())

  user User? @relation("AuditActor", fields: [userId], references: [id])

  @@index([tenantId, timestamp])
  @@index([userId, timestamp])
  @@index([category, eventType])
  @@index([resourceType, resourceId])
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  EXPIRED
  CANCELLED
}

enum DecisionType {
  APPROVE
  REJECT
  ESCALATE
}

model Grade {
  id            String      @id @default(uuid())
  code          String      @unique
  name          String
  family        GradeFamily
  specStandard  String?
  chemistryMin  Json?
  chemistryMax  Json?
  tensileMin    Decimal?
  tensileMax    Decimal?
  yieldMin      Decimal?
  yieldMax      Decimal?
  elongationMin Decimal?
  hardnessMin   Decimal?
  hardnessMax   Decimal?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coils         Coil[]
  heats         Heat[]
  orderLines    OrderLine[]
  products      Product[]
}

model Product {
  id           String      @id @default(uuid())
  sku          String      @unique
  name         String
  description  String?
  category     String?
  productType  ProductType
  form         ProductForm
  gradeId      String?
  specStandard String?
  thicknessMin Decimal?
  thicknessMax Decimal?
  widthMin     Decimal?
  widthMax     Decimal?
  basePriceCwt Decimal?
  priceUnit    PriceUnit   @default(CWT)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  coils        Coil[]
  orderLines   OrderLine[]
  grade        Grade?      @relation(fields: [gradeId], references: [id])
}

model Heat {
  id              String       @id @default(uuid())
  heatNumber      String       @unique
  millId          String
  gradeId         String
  castDate        DateTime
  meltType        MeltType?
  castType        CastType?
  chemistry       Json?
  mechanicalProps Json?
  totalWeightLb   Decimal?
  status          HeatStatus   @default(ACTIVE)
  mtrDocumentId   String?
  createdAt       DateTime     @default(now())
  createdById     String
  updatedAt       DateTime     @updatedAt
  coils           Coil[]
  createdBy       User         @relation("HeatCreator", fields: [createdById], references: [id])
  grade           Grade        @relation(fields: [gradeId], references: [id])
  mill            Organization @relation(fields: [millId], references: [id])
  mtrDocument     Document?    @relation(fields: [mtrDocumentId], references: [id])
  testResults     TestResult[]
}

model Coil {
  id               String                @id @default(uuid())
  coilNumber       String                @unique
  heatId           String
  parentCoilId     String?
  productId        String?
  gradeId          String
  ownerId          String
  form             ProductForm
  thicknessIn      Decimal?
  widthIn          Decimal?
  lengthIn         Decimal?
  odIn             Decimal?
  idIn             Decimal?
  gauge            Int?
  grossWeightLb    Decimal
  netWeightLb      Decimal
  temper           String?
  finish           String?
  coating          String?
  coatingWeight    String?
  edgeCondition    EdgeCondition?
  status           CoilStatus            @default(AVAILABLE)
  qcStatus         QCStatus              @default(PENDING)
  holdCode         String?
  locationId       String?
  binLocation      String?
  unitCost         Decimal?
  landedCost       Decimal?
  originOrderId    String?
  createdAt        DateTime              @default(now())
  createdById      String
  updatedAt        DateTime              @updatedAt
  createdBy        User                  @relation("CoilCreator", fields: [createdById], references: [id])
  grade            Grade                 @relation(fields: [gradeId], references: [id])
  heat             Heat                  @relation(fields: [heatId], references: [id])
  location         Location?             @relation(fields: [locationId], references: [id])
  originOrder      Order?                @relation("OriginOrder", fields: [originOrderId], references: [id])
  owner            Organization          @relation(fields: [ownerId], references: [id])
  parentCoil       Coil?                 @relation("CoilParent", fields: [parentCoilId], references: [id])
  childCoils       Coil[]                @relation("CoilParent")
  product          Product?              @relation(fields: [productId], references: [id])
  documentLinks    DocumentLink[]
  inventory        Inventory?
  movements        MaterialMovement[]
  allocations      OrderLineAllocation[]
  qcHolds          QCHold[]
  testResults      TestResult[]
  workOrderInputs  WorkOrder[]           @relation("WorkOrderInput")
  workOrderOutputs WorkOrderOutput[]
}

model Location {
  id            String             @id @default(uuid())
  code          String             @unique
  name          String
  type          LocationType
  parentId      String?
  ownerId       String
  addressLine1  String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  lat           Decimal?
  lng           Decimal?
  maxWeightLb   Decimal?
  isOutdoor     Boolean            @default(false)
  hasCrane      Boolean            @default(false)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  coils         Coil[]
  inventories   Inventory[]
  owner         Organization       @relation(fields: [ownerId], references: [id])
  parent        Location?          @relation("LocationHierarchy", fields: [parentId], references: [id])
  children      Location[]         @relation("LocationHierarchy")
  movementsFrom MaterialMovement[] @relation("MovementFrom")
  movementsTo   MaterialMovement[] @relation("MovementTo")
  shipments     Shipment[]
  workCenters   WorkCenter[]
  usersHome     User[]             @relation("UserHomeLocation")
  userLocations UserLocation[]
  assets        Asset[]            @relation("AssetSite")
  packages      Package[]          @relation("PackageLocation")
  dropTagListings DropTagListing[] @relation("ListingOrigin")
  operatorsHome Operator[]         @relation("OperatorHomeLocation")
}

model Inventory {
  id            String    @id @default(uuid())
  coilId        String    @unique
  locationId    String
  qtyOnHand     Decimal
  qtyAvailable  Decimal
  qtyAllocated  Decimal   @default(0)
  qtyOnHold     Decimal   @default(0)
  unit          String    @default("LB")
  unitCost      Decimal?
  landedCost    Decimal?
  avgCost       Decimal?
  lastCountDate DateTime?
  lastMovement  DateTime?
  status        String    @default("ACTIVE")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  coil          Coil      @relation(fields: [coilId], references: [id])
  location      Location  @relation(fields: [locationId], references: [id])
}

model MaterialMovement {
  id             String       @id @default(uuid())
  coilId         String
  movementType   MovementType
  fromLocationId String?
  toLocationId   String?
  qtyMoved       Decimal
  unit           String       @default("LB")
  orderId        String?
  workOrderId    String?
  shipmentId     String?
  reasonCode     String?
  notes          String?
  createdAt      DateTime     @default(now())
  createdById    String
  coil           Coil         @relation(fields: [coilId], references: [id])
  createdBy      User         @relation(fields: [createdById], references: [id])
  fromLocation   Location?    @relation("MovementFrom", fields: [fromLocationId], references: [id])
  order          Order?       @relation(fields: [orderId], references: [id])
  shipment       Shipment?    @relation(fields: [shipmentId], references: [id])
  toLocation     Location?    @relation("MovementTo", fields: [toLocationId], references: [id])
  workOrder      WorkOrder?   @relation(fields: [workOrderId], references: [id])
}

model TestResult {
  id           String   @id @default(uuid())
  coilId       String?
  heatId       String
  testType     TestType
  testDate     DateTime
  results      Json
  specLimits   Json?
  passFail     PassFail
  equipmentId  String?
  labId        String?
  testedById   String
  approvedById String?
  certNumber   String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  approvedBy   User?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  coil         Coil?    @relation(fields: [coilId], references: [id])
  heat         Heat     @relation(fields: [heatId], references: [id])
  testedBy     User     @relation("TestedBy", fields: [testedById], references: [id])
}

model QCHold {
  id              String       @id @default(uuid())
  coilId          String
  holdType        HoldType
  holdReason      String
  holdDate        DateTime     @default(now())
  holdById        String
  status          HoldStatus   @default(ACTIVE)
  disposition     Disposition?
  resolvedDate    DateTime?
  resolvedById    String?
  resolutionNotes String?
  ncrId           String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  coil            Coil         @relation(fields: [coilId], references: [id])
  holdBy          User         @relation("HoldBy", fields: [holdById], references: [id])
  resolvedBy      User?        @relation("ResolvedBy", fields: [resolvedById], references: [id])
}

model RFQ {
  id            String       @id @default(uuid())
  rfqNumber     String       @unique
  customerId    String
  status        RFQStatus    @default(DRAFT)
  contactName   String?
  contactEmail  String?
  contactPhone  String?
  requestedDate DateTime?
  notes         String?
  submittedAt   DateTime?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  quotes        Quote[]
  customer      Organization @relation("CustomerRFQs", fields: [customerId], references: [id])
  lines         RFQLine[]
}

model RFQLine {
  id             String      @id @default(uuid())
  rfqId          String
  lineNumber     Int
  materialCode   String?
  division       String?
  productId      String?
  description    String?
  requestedQty   Decimal
  unit           String      @default("LB")
  specifications Json?
  notes          String?
  createdAt      DateTime    @default(now())
  quoteLines     QuoteLine[]
  rfq            RFQ         @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model Quote {
  id               String      @id @default(uuid())
  quoteNumber      String      @unique
  rfqId            String
  version          Int         @default(1)
  status           QuoteStatus @default(DRAFT)
  subtotal         Decimal?
  taxAmount        Decimal?
  freightAmount    Decimal?
  totalAmount      Decimal?
  currency         String      @default("USD")
  validFrom        DateTime    @default(now())
  validUntil       DateTime?
  paymentTerms     String?
  freightTerms     String?
  notes            String?
  internalNotes    String?
  createdById      String?
  sentAt           DateTime?
  acceptedAt       DateTime?
  convertedOrderId String?     @unique
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  convertedOrder   Order?      @relation("QuoteToOrder", fields: [convertedOrderId], references: [id])
  rfq              RFQ         @relation(fields: [rfqId], references: [id])
  lines            QuoteLine[]
}

model QuoteLine {
  id            String   @id @default(uuid())
  quoteId       String
  rfqLineId     String?
  lineNumber    Int
  productId     String?
  description   String?
  quantity      Decimal
  unit          String   @default("LB")
  unitPrice     Decimal?
  priceUnit     String   @default("CWT")
  extendedPrice Decimal?
  leadTimeDays  Int?
  notes         String?
  createdAt     DateTime @default(now())
  quote         Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  rfqLine       RFQLine? @relation(fields: [rfqLineId], references: [id])
}

// ============================================================================
// STAFF & OPERATOR MANAGEMENT
// ============================================================================

model Operator {
  id                       String          @id @default(uuid())
  userId                   String?         @unique
  employeeCode             String          @unique
  firstName                String
  lastName                 String
  email                    String?
  phone                    String?
  homeLocationId           String?
  homeWorkCenterId         String?
  hireDate                 DateTime?
  status                   OperatorStatus  @default(ACTIVE)
  maxThicknessInches       Decimal?
  hourlyRate               Decimal?
  overtimeMultiplier       Decimal?        @default(1.5)
  notes                    String?
  avatarUrl                String?
  emergencyContactName     String?
  emergencyContactPhone    String?
  isActive                 Boolean         @default(true)
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt

  user                     User?           @relation(fields: [userId], references: [id])
  homeLocation             Location?       @relation("OperatorHomeLocation", fields: [homeLocationId], references: [id])
  homeWorkCenter           WorkCenter?     @relation("OperatorHomeWorkCenter", fields: [homeWorkCenterId], references: [id])
  skills                   OperatorSkill[]
  shifts                   Shift[]
  inspections              JobInspection[] @relation("InspectorInspections")

  @@index([homeLocationId])
  @@index([status])
}

model OperatorSkill {
  id                String      @id @default(uuid())
  operatorId        String
  workCenterTypeId  String
  skillLevel        SkillLevel  @default(STANDARD)
  certifiedDate     DateTime    @default(now())
  expiresAt         DateTime?
  certificationRef  String?
  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  operator          Operator    @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@unique([operatorId, workCenterTypeId])
  @@index([workCenterTypeId])
}

model Shift {
  id              String     @id @default(uuid())
  operatorId      String
  locationId      String?
  workCenterId    String?
  shiftDate       DateTime
  startTime       DateTime
  endTime         DateTime
  shiftType       ShiftType  @default(DAY)
  breakMinutes    Int        @default(30)
  status          ShiftStatus @default(SCHEDULED)
  notes           String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  operator        Operator   @relation(fields: [operatorId], references: [id], onDelete: Cascade)

  @@index([operatorId, shiftDate])
  @@index([locationId, shiftDate])
}

enum OperatorStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
  TRAINING
}

enum SkillLevel {
  NOVICE
  STANDARD
  ADVANCED
  EXPERT
}

enum ShiftType {
  DAY
  NIGHT
  SWING
  SPLIT
  OVERTIME
}

enum ShiftStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
  NO_SHOW
}

// ============================================================================
// DISPATCH ENGINE — Persistent Job Routing & Operations
// ============================================================================

model DispatchJob {
  id                String              @id @default(uuid())
  jobId             String              @unique
  jobNumber         String
  orderId           String?
  materialCode      String?
  commodity         String              @default("METALS")
  form              String              @default("PLATE")
  grade             String?
  thickness         Decimal             @default(0.5)
  division          String              @default("METALS")
  locationId        String              @default("FWA")
  dueDate           DateTime?
  priority          String              @default("NORMAL")
  customerName      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  job               Job                 @relation(fields: [jobId], references: [id], onDelete: Cascade)
  operations        DispatchOperation[]

  @@index([locationId])
  @@index([jobNumber])
}

model DispatchOperation {
  id                      String       @id @default(uuid())
  dispatchJobId           String
  sequence                Int
  name                    String
  requiredWorkCenterType  String
  requiredDivision        String       @default("METALS")
  requiredSkillLevel      String       @default("STANDARD")
  specialization          String?
  thickness               Decimal      @default(0.5)
  materialCode            String?
  status                  String       @default("PENDING")
  assignedWorkCenterId    String?
  assignedOperatorId      String?
  scheduledStart          DateTime?
  scheduledEnd            DateTime?
  actualStart             DateTime?
  actualEnd               DateTime?
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt

  dispatchJob             DispatchJob  @relation(fields: [dispatchJobId], references: [id], onDelete: Cascade)
  timeLogs                DispatchTimeLog[]

  @@index([dispatchJobId])
  @@index([assignedWorkCenterId])
  @@index([status])
  @@unique([dispatchJobId, sequence])
}

model DispatchTimeLog {
  id                    String            @id @default(uuid())
  dispatchOperationId   String
  jobId                 String?
  operatorId            String?
  workCenterId          String?
  status                String            @default("RUNNING")    // RUNNING, PAUSED, COMPLETE
  startAt               DateTime          @default(now())
  endAt                 DateTime?
  downtimeReason        String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  dispatchOperation     DispatchOperation @relation(fields: [dispatchOperationId], references: [id], onDelete: Cascade)

  @@index([dispatchOperationId])
  @@index([operatorId])
  @@index([status])
}

// ── Job-Level QC Inspection ─────────────────────────────────────────────────────
model JobInspection {
  id                  String       @id @default(uuid())
  inspectionNumber    String       @unique
  jobId               String
  inspectorId         String?
  status              String       @default("PENDING")    // PENDING, IN_PROGRESS, PASSED, FAILED, CONDITIONAL
  overallResult       String?                              // PASS, FAIL, CONDITIONAL
  disposition         String?                              // USE_AS_IS, REWORK, SCRAP, RETURN, SELL_SECONDARY, PENDING
  inspectionType      String       @default("FINAL")      // FINAL, IN_PROCESS, FIRST_ARTICLE, RECEIVING
  checklist           Json?                                // Array of {item, required, result, notes}
  dimensionalChecks   Json?                                // Array of {dimension, nominal, tolerance, actual, pass}
  visualNotes         String?
  defects             Json?                                // Array of {type, severity, description, location, photo}
  reworkInstructions  String?
  notes               String?
  startedAt           DateTime?
  completedAt         DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  job                 Job          @relation(fields: [jobId], references: [id], onDelete: Cascade)
  inspector           Operator?    @relation("InspectorInspections", fields: [inspectorId], references: [id])

  @@index([jobId])
  @@index([inspectorId])
  @@index([status])
}

model WorkCenterType {
  id          String   @id
  label       String
  icon        String   @default("Build")
  color       String   @default("#1976d2")
  description String?
  divisions   String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model WorkCenter {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  locationId   String
  type         String?
  capabilities String[]
  capacity     Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  jobs         Job[]
  location     Location @relation(fields: [locationId], references: [id])
  assets       Asset[]  @relation("AssetWorkCenter")
  operatorsHome Operator[] @relation("OperatorHomeWorkCenter")
}

model Job {
  id               String      @id @default(uuid())
  jobNumber        String      @unique
  orderId          String?
  orderLineId      String?
  workCenterId     String?
  workOrderId      String?
  assignedToId     String?
  createdById      String?
  status           JobStatus   @default(SCHEDULED)
  operationType    String?
  priority         Int         @default(3)
  scheduledStart   DateTime?
  scheduledEnd     DateTime?
  actualStart      DateTime?
  actualEnd        DateTime?
  inputWeightLb    Decimal?
  outputWeightLb   Decimal?
  scrapWeightLb    Decimal?
  operatorId       String?
  instructions     String?
  notes            String?
  shippingCarrier  String?
  trackingNumber   String?
  shippedAt        DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  hasCustomRouting Boolean     @default(false)
  recipeId         String?
  recipeVersion    Int?
  assignedTo       User?       @relation("JobAssignee", fields: [assignedToId], references: [id])
  createdBy        User?       @relation("JobCreator", fields: [createdById], references: [id])
  order            Order?      @relation(fields: [orderId], references: [id])
  recipe           BomRecipe?  @relation("JobRecipe", fields: [recipeId], references: [id])
  workCenter       WorkCenter? @relation(fields: [workCenterId], references: [id])
  dropTags         DropTag[]
  packages         Package[]
  dispatchJob      DispatchJob?
  inspections      JobInspection[]

  @@index([recipeId])
}

model Order {
  id            String             @id @default(uuid())
  orderNumber   String             @unique
  orderType     OrderType
  buyerId       String?
  sellerId      String?
  shipToAddress String?
  shipToCity    String?
  shipToState   String?
  shipToZip     String?
  orderDate     DateTime           @default(now())
  requiredDate  DateTime?
  promisedDate  DateTime?
  expireDate    DateTime?
  status        OrderStatus        @default(DRAFT)
  subtotal      Decimal?
  taxAmount     Decimal?
  freightAmount Decimal?
  totalAmount   Decimal?
  currency      String             @default("USD")
  paymentTerms  String?
  freightTerms  FreightTerms?
  poReference   String?
  notes         String?
  createdAt     DateTime           @default(now())
  createdById   String
  updatedAt     DateTime           @updatedAt
  originCoils   Coil[]             @relation("OriginOrder")
  invoices      Invoice[]
  jobs          Job[]
  movements     MaterialMovement[]
  buyer         Organization?      @relation("BuyerOrders", fields: [buyerId], references: [id])
  createdBy     User               @relation("OrderCreator", fields: [createdById], references: [id])
  seller        Organization?      @relation("SellerOrders", fields: [sellerId], references: [id])
  lines         OrderLine[]
  fromQuote     Quote?             @relation("QuoteToOrder")
  shipments     Shipment[]
  dropTags      DropTag[]
  packages      Package[]
}

model OrderLine {
  id            String                @id @default(uuid())
  orderId       String
  lineNumber    Int
  productId     String?
  gradeId       String?
  description   String?
  thicknessIn   Decimal?
  widthIn       Decimal?
  lengthIn      Decimal?
  finish        String?
  coating       String?
  qtyOrdered    Decimal
  qtyShipped    Decimal               @default(0)
  qtyReceived   Decimal               @default(0)
  unit          String                @default("LB")
  unitPrice     Decimal?
  priceUnit     PriceUnit             @default(CWT)
  discountPct   Decimal?
  extendedPrice Decimal?
  lineStatus    LineStatus            @default(OPEN)
  notes         String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  grade         Grade?                @relation(fields: [gradeId], references: [id])
  order         Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?              @relation(fields: [productId], references: [id])
  allocations   OrderLineAllocation[]
  shipmentItems ShipmentItem[]
  dropTags      DropTag[]
  packages      Package[]
}

model OrderLineAllocation {
  id           String    @id @default(uuid())
  orderLineId  String
  coilId       String
  qtyAllocated Decimal
  allocatedAt  DateTime  @default(now())
  coil         Coil      @relation(fields: [coilId], references: [id])
  orderLine    OrderLine @relation(fields: [orderLineId], references: [id], onDelete: Cascade)
}

model WorkOrder {
  id             String             @id @default(uuid())
  woNumber       String             @unique
  woType         WOType
  status         WOStatus           @default(DRAFT)
  sourceCoilId   String
  lineId         String?
  salesOrderId   String?
  priority       Int                @default(3)
  scheduledDate  DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  slitPattern    Json?
  inputWeightLb  Decimal?
  outputWeightLb Decimal?
  scrapWeightLb  Decimal?
  yieldPct       Decimal?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  movements      MaterialMovement[]
  sourceCoil     Coil               @relation("WorkOrderInput", fields: [sourceCoilId], references: [id])
  outputs        WorkOrderOutput[]
}

model WorkOrderOutput {
  id           String    @id @default(uuid())
  workOrderId  String
  outputCoilId String
  sequence     Int
  targetWidth  Decimal?
  actualWidth  Decimal?
  actualWeight Decimal?
  destination  String?
  createdAt    DateTime  @default(now())
  outputCoil   Coil      @relation(fields: [outputCoilId], references: [id])
  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model Shipment {
  id             String             @id @default(uuid())
  shipmentNumber String             @unique
  orderId        String
  fromLocationId String
  carrierId      String?
  carrierName    String?
  truckNumber    String?
  driverName     String?
  driverPhone    String?
  status         ShipmentStatus     @default(PENDING)
  scheduledDate  DateTime?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  totalWeightLb  Decimal?
  bolNumber      String?
  podCaptured    Boolean            @default(false)
  podImageUrl    String?
  podSignature   String?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  movements      MaterialMovement[]
  fromLocation   Location           @relation(fields: [fromLocationId], references: [id])
  order          Order              @relation(fields: [orderId], references: [id])
  items          ShipmentItem[]
  stops          ShipmentStop[]
  dropTags       DropTag[]
  dropTagListings DropTagListing[]
}

model ShipmentItem {
  id          String    @id @default(uuid())
  shipmentId  String
  orderLineId String
  qtyShipped  Decimal
  weightLb    Decimal?
  createdAt   DateTime  @default(now())
  orderLine   OrderLine @relation(fields: [orderLineId], references: [id])
  shipment    Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
}

model ShipmentStop {
  id            String    @id @default(uuid())
  shipmentId    String
  stopNumber    Int
  address       String
  city          String?
  state         String?
  zipCode       String?
  scheduledTime DateTime?
  arrivedAt     DateTime?
  departedAt    DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  shipment      Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  orderId       String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?
  subtotal      Decimal
  taxAmount     Decimal       @default(0)
  freightAmount Decimal       @default(0)
  totalAmount   Decimal
  paidAmount    Decimal       @default(0)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  order         Order         @relation(fields: [orderId], references: [id])
  payments      Payment[]
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  amount          Decimal
  paymentDate     DateTime @default(now())
  paymentMethod   String?
  referenceNumber String?
  notes           String?
  createdAt       DateTime @default(now())
  invoice         Invoice  @relation(fields: [invoiceId], references: [id])
}

model Document {
  id             String         @id @default(uuid())
  documentType   DocumentType
  documentNumber String?
  title          String?
  fileName       String
  fileType       String?
  fileSizeBytes  Int?
  storagePath    String
  checksum       String?
  extractedData  Json?
  isVerified     Boolean        @default(false)
  verifiedById   String?
  verifiedAt     DateTime?
  issueDate      DateTime?
  expiryDate     DateTime?
  ownerId        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  owner          Organization?  @relation(fields: [ownerId], references: [id])
  links          DocumentLink[]
  heats          Heat[]
}

model DocumentLink {
  id         String   @id @default(uuid())
  documentId String
  entityType String
  entityId   String
  linkType   String   @default("PRIMARY")
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  coil       Coil     @relation(fields: [entityId], references: [id], map: "document_coil_link")
}

model CommodityPrice {
  id            String   @id @default(uuid())
  indexCode     String
  indexName     String
  price         Decimal
  unit          String
  effectiveDate DateTime
  source        String?
  createdAt     DateTime @default(now())

  @@index([indexCode, effectiveDate])
}

model BomRecipe {
  id           String          @id @default(uuid())
  name         String
  code         String
  materialCode String?
  commodity    String?
  form         String?
  grade        String?
  thicknessMin Decimal?
  thicknessMax Decimal?
  division     String?
  version      Int             @default(1)
  status       BomRecipeStatus @default(DRAFT)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  operations   BomOperation[]
  jobs         Job[]           @relation("JobRecipe")

  @@index([code, version])
  @@index([status])
  @@index([materialCode])
  @@index([commodity, form, grade])
}

model BomOperation {
  id                      String    @id @default(uuid())
  recipeId                String
  sequence                Int
  name                    String
  workCenterType          String
  estimatedMachineMinutes Int       @default(0)
  estimatedLaborMinutes   Int       @default(0)
  setupMinutes            Int       @default(0)
  parameters              Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  recipe                  BomRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId, sequence])
}

enum OrgType {
  MILL
  SERVICE_CENTER
  DISTRIBUTOR
  BROKER
  FABRICATOR
  OEM
}

enum UserRole {
  // System Roles
  SUPER_ADMIN
  TENANT_OWNER

  // Executive Roles
  EXECUTIVE
  CFO
  COO
  CIO

  // Division/Branch Roles
  DIVISION_DIRECTOR
  BRANCH_MANAGER

  // Sales Roles
  SALES_DIRECTOR
  SALES_REP
  CSR
  ESTIMATOR
  CREDIT_MANAGER

  // Operations Roles
  OPS_MANAGER
  PRODUCTION_MANAGER
  SCHEDULER
  INVENTORY_MANAGER
  BUYER
  WORKCENTER_LEAD

  // Shop Floor Roles
  OPERATOR_SAW
  OPERATOR_ROUTER
  OPERATOR_SHEAR
  OPERATOR_PLASMA
  OPERATOR_GENERAL
  MATERIAL_HANDLER
  RECEIVING_CLERK
  SHIPPING_COORDINATOR
  PACKAGING_LEAD

  // Quality Roles
  QC_MANAGER
  QC_INSPECTOR

  // Support Roles
  MAINTENANCE_MANAGER
  INTEGRATION_ADMIN
  DATA_ANALYST
  SUPPORT_AGENT
  AUDITOR

  // External Portal Roles
  CUSTOMER_ADMIN
  CUSTOMER_BUYER
  CUSTOMER_VIEWER
  SUPPLIER_USER
  CARRIER_USER

  // Legacy (for backward compatibility)
  ADMIN
  MILL_OPERATOR
  SERVICE_CENTER
  SALES
  QUALITY
  LOGISTICS
  FINANCE
  VIEWER
}

enum GradeFamily {
  CARBON
  ALLOY
  STAINLESS
  TOOL
  HSLA
}

enum ProductType {
  FLAT
  LONG
  TUBE
  STRUCTURAL
}

enum ProductForm {
  COIL
  SHEET
  PLATE
  BAR
  TUBE
  BEAM
  REBAR
  WIRE
}

enum PriceUnit {
  CWT
  LB
  TON
  EACH
  LF
}

enum MeltType {
  BOF
  EAF
  AOD
}

enum CastType {
  CONTINUOUS
  INGOT
}

enum HeatStatus {
  ACTIVE
  CONSUMED
  ARCHIVED
}

enum EdgeCondition {
  MILL
  SLIT
  TRIMMED
}

enum CoilStatus {
  AVAILABLE
  ALLOCATED
  IN_PROCESS
  HOLD
  SHIPPED
  CONSUMED
}

enum QCStatus {
  PENDING
  PASSED
  FAILED
  HOLD
}

enum LocationType {
  WAREHOUSE
  YARD
  RACK
  BIN
  FLOOR
}

enum MovementType {
  RECEIVE
  SHIP
  TRANSFER
  ADJUST
  PROCESS
  CONSUME
  SCRAP
  COUNT
}

enum TestType {
  CHEMISTRY
  MECHANICAL
  DIMENSIONAL
  SURFACE
  COATING
  OTHER
}

enum PassFail {
  PASS
  FAIL
  CONDITIONAL
}

enum HoldType {
  QUALITY
  CUSTOMER
  PENDING_TEST
  DAMAGE
  DISPUTE
  OTHER
}

enum HoldStatus {
  ACTIVE
  RELEASED
  SCRAPPED
  RETURNED
}

enum Disposition {
  USE_AS_IS
  REWORK
  SCRAP
  RETURN
  SELL_SECONDARY
  PENDING
}

enum RFQStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
  WITHDRAWN
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  SENT
  COUNTERED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum JobStatus {
  ORDERED
  SCHEDULED
  IN_PROCESS
  WAITING_QC
  PACKAGING
  READY_TO_SHIP
  SHIPPED
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum OrderType {
  RFQ
  QUOTE
  SO
  PO
  RETURN
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  PARTIAL
  COMPLETE
  CANCELLED
  HOLD
}

enum FreightTerms {
  PREPAID
  COLLECT
  THIRD_PARTY
}

enum LineStatus {
  OPEN
  PARTIAL
  COMPLETE
  CANCELLED
}

enum WOType {
  SLIT
  CTL
  BLANK
  LEVELCUT
  MULTIBLANKING
  SHEAR
}

enum WOStatus {
  DRAFT
  READY
  IN_PROGRESS
  QC_HOLD
  COMPLETE
  CANCELLED
}

enum ShipmentStatus {
  PENDING
  LOADING
  IN_TRANSIT
  DELIVERED
  EXCEPTION
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum DocumentType {
  MTR
  CERT
  BOL
  POD
  INVOICE
  SPEC
  COA
  MSDS
  DRAWING
  OTHER
}

enum BomRecipeStatus {
  DRAFT
  REVIEW
  ACTIVE
  DEPRECATED
  ARCHIVED
}

// ============================================================================
// MAINTENANCE & RELIABILITY MODULE
// ============================================================================

model Asset {
  id          String  @id @default(uuid())
  assetNumber String  @unique
  name        String
  description String?
  assetTypeId String

  // Hierarchy
  parentAssetId String?
  siteId        String // Location reference
  areaCode      String?
  workCenterId  String?

  // Equipment Details
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime?
  installDate       DateTime?
  warrantyExpires   DateTime?
  expectedLifeYears Int?
  replacementCost   Decimal?

  // Criticality
  criticality    AssetCriticality @default(C)
  safetyRelated  Boolean          @default(false)
  qualityRelated Boolean          @default(false)

  // Status
  status          AssetStatus @default(IN_SERVICE)
  statusReason    String?
  statusChangedAt DateTime?
  statusChangedBy String?

  // Metering
  currentHours  Decimal?
  currentCycles Int?
  currentMiles  Decimal?

  // PM Information
  lastPMDate         DateTime?
  nextPMDueDate      DateTime?
  pmComplianceStatus PMComplianceStatus?

  // Certification
  certificationRequired Boolean   @default(false)
  certificationExpires  DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assetType   AssetType   @relation(fields: [assetTypeId], references: [id])
  parentAsset Asset?      @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets Asset[]     @relation("AssetHierarchy")
  site        Location    @relation("AssetSite", fields: [siteId], references: [id])
  workCenter  WorkCenter? @relation("AssetWorkCenter", fields: [workCenterId], references: [id])

  components        AssetComponent[]
  meterReadings     MeterReading[]
  maintenanceOrders MaintenanceOrder[]
  pmSchedules       PMSchedule[]
  downtimeRecords   DowntimeRecord[]
  spareParts        SparePart[]

  @@index([assetNumber])
  @@index([siteId])
  @@index([status])
  @@index([criticality])
  @@index([assetTypeId])
}

model AssetType {
  id                 String           @id @default(uuid())
  code               String           @unique
  name               String
  category           String? // SAW, ROUTER, FORKLIFT, CRANE, etc.
  description        String?
  defaultCriticality AssetCriticality @default(C)
  pmTemplateId       String?

  // Default Intervals
  defaultPMIntervalDays  Int?
  defaultPMIntervalHours Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets      Asset[]
  pmTemplates PMTemplate[]

  @@index([code])
  @@index([category])
}

model AssetComponent {
  id                String          @id @default(uuid())
  assetId           String
  name              String
  partNumber        String?
  serialNumber      String?
  manufacturer      String?
  installDate       DateTime?
  warrantyExpires   DateTime?
  expectedLifeHours Int?
  currentHours      Decimal?
  status            ComponentStatus @default(ACTIVE)
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

model MeterReading {
  id          String    @id @default(uuid())
  assetId     String
  meterType   MeterType
  reading     Decimal
  readingDate DateTime  @default(now())
  recordedBy  String
  source      String? // MANUAL, AUTOMATIC, IMPORT
  notes       String?

  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, meterType])
  @@index([readingDate])
}

// Work Order for Maintenance
model MaintenanceOrder {
  id       String @id @default(uuid())
  woNumber String @unique
  assetId  String

  // Type & Priority
  type     MaintenanceOrderType
  priority MaintenancePriority  @default(NORMAL)

  // Description
  title       String
  description String?
  problemCode String?
  failureCode String?

  // Scheduling
  status         MaintenanceOrderStatus @default(DRAFT)
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  estimatedHours Decimal?

  // Execution
  actualStart DateTime?
  actualEnd   DateTime?
  actualHours Decimal?

  // Assignment
  assignedToId String?
  assignedTeam String?

  // Safety
  lotoRequired          Boolean @default(false)
  permitRequired        Boolean @default(false)
  hotWorkRequired       Boolean @default(false)
  confinedSpaceRequired Boolean @default(false)
  safetyRelated         Boolean @default(false)

  // Linked Records
  pmScheduleId     String?
  pmTemplateId     String?
  downtimeRecordId String?
  stopWorkId       String?
  ncrId            String?
  spcViolationId   String?

  // Verification
  requiresFirstArticle Boolean  @default(false)
  firstArticlePassed   Boolean?
  testRunPassed        Boolean?

  // Approval
  submittedAt DateTime?
  submittedBy String?
  approvedAt  DateTime?
  approvedBy  String?

  // Completion
  completedAt     DateTime?
  completedBy     String?
  completionNotes String?

  // Verification & Closure
  verifiedAt        DateTime?
  verifiedBy        String?
  verificationNotes String?
  closedAt          DateTime?
  closedBy          String?

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt

  // Relations
  asset          Asset           @relation(fields: [assetId], references: [id])
  pmSchedule     PMSchedule?     @relation(fields: [pmScheduleId], references: [id])
  pmTemplate     PMTemplate?     @relation(fields: [pmTemplateId], references: [id])
  downtimeRecord DowntimeRecord? @relation(fields: [downtimeRecordId], references: [id])

  tasks       MaintenanceTask[]
  parts       MaintenanceOrderPart[]
  labor       MaintenanceOrderLabor[]
  attachments MaintenanceAttachment[]

  @@index([woNumber])
  @@index([assetId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([scheduledStart])
}

model MaintenanceTask {
  id                 String     @id @default(uuid())
  maintenanceOrderId String
  sequence           Int
  description        String
  estimatedMinutes   Int?
  actualMinutes      Int?
  status             TaskStatus @default(PENDING)
  completedAt        DateTime?
  completedBy        String?
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId, sequence])
}

model MaintenanceOrderPart {
  id                 String    @id @default(uuid())
  maintenanceOrderId String
  sparePartId        String?
  partNumber         String
  partDescription    String?
  quantityRequired   Decimal
  quantityUsed       Decimal   @default(0)
  unitCost           Decimal?
  issuedAt           DateTime?
  issuedBy           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)
  sparePart        SparePart?       @relation(fields: [sparePartId], references: [id])

  @@index([maintenanceOrderId])
}

model MaintenanceOrderLabor {
  id                 String    @id @default(uuid())
  maintenanceOrderId String
  technicianId       String
  technicianName     String
  startTime          DateTime
  endTime            DateTime?
  regularHours       Decimal   @default(0)
  overtimeHours      Decimal   @default(0)
  laborRate          Decimal?
  notes              String?

  createdAt DateTime @default(now())

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId])
}

model MaintenanceAttachment {
  id                 String         @id @default(uuid())
  maintenanceOrderId String
  type               AttachmentType
  fileName           String
  fileType           String?
  fileSizeBytes      Int?
  storagePath        String
  description        String?
  uploadedAt         DateTime       @default(now())
  uploadedBy         String

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId])
}

// PM Templates
model PMTemplate {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  assetTypeId String?

  // Default Schedule
  intervalType  PMIntervalType
  intervalValue Int
  intervalUnit  String? // DAYS, HOURS, MILES, CYCLES

  // Trigger Settings
  triggerOnHours     Boolean @default(false)
  triggerOnCalendar  Boolean @default(true)
  triggerOnCondition Boolean @default(false)
  conditionThreshold Json?

  // Default Task List
  taskList Json? // Array of task templates

  // Default Parts
  defaultParts Json? // Array of part requirements

  // Safety
  lotoRequired   Boolean  @default(false)
  permitRequired Boolean  @default(false)
  estimatedHours Decimal?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assetType         AssetType?         @relation(fields: [assetTypeId], references: [id])
  pmSchedules       PMSchedule[]
  maintenanceOrders MaintenanceOrder[]

  @@index([code])
  @@index([assetTypeId])
}

model PMSchedule {
  id           String  @id @default(uuid())
  assetId      String
  pmTemplateId String?

  // Schedule
  intervalType  PMIntervalType
  intervalValue Int
  intervalUnit  String?

  // Trigger Tracking
  lastCompletedDate  DateTime?
  lastCompletedHours Decimal?
  nextDueDate        DateTime?
  nextDueHours       Decimal?

  // Overdue Handling
  overdueAction        OverdueAction @default(ALERT)
  overdueThresholdDays Int?

  // Status
  status PMScheduleStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset             Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  pmTemplate        PMTemplate?        @relation(fields: [pmTemplateId], references: [id])
  maintenanceOrders MaintenanceOrder[]

  @@index([assetId])
  @@index([nextDueDate])
  @@index([status])
}

// Downtime Tracking
model DowntimeRecord {
  id      String @id @default(uuid())
  assetId String

  // Timing
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?

  // Classification
  type              DowntimeType
  reasonCode        String?
  reasonDescription String?

  // Impact
  impactedJobs        String[] // Array of job IDs
  productionLossUnits Decimal?
  estimatedCost       Decimal?

  // Reporting
  reportedBy String
  reportedAt DateTime @default(now())
  symptoms   String?

  // Resolution
  resolvedBy      String?
  resolutionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset             Asset              @relation(fields: [assetId], references: [id])
  maintenanceOrders MaintenanceOrder[]

  @@index([assetId])
  @@index([startTime])
  @@index([type])
}

// Spare Parts Inventory
model SparePart {
  id           String  @id @default(uuid())
  partNumber   String  @unique
  name         String
  description  String?
  category     String?
  manufacturer String?

  // Inventory
  quantityOnHand   Decimal @default(0)
  quantityReserved Decimal @default(0)
  quantityOnOrder  Decimal @default(0)
  reorderPoint     Int?
  reorderQuantity  Int?
  unitOfMeasure    String  @default("EACH")

  // Cost
  unitCost          Decimal?
  lastPurchasePrice Decimal?
  lastPurchaseDate  DateTime?

  // Location
  storageLocation String?
  binNumber       String?

  // Asset Links
  assetId       String? // Optional: specific asset
  assetTypeCode String? // Or: applies to asset type

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset        Asset?                 @relation(fields: [assetId], references: [id])
  orderParts   MaintenanceOrderPart[]
  transactions SparePartTransaction[]

  @@index([partNumber])
  @@index([category])
  @@index([assetId])
}

model SparePartTransaction {
  id              String              @id @default(uuid())
  sparePartId     String
  transactionType PartTransactionType
  quantity        Decimal
  unitCost        Decimal?
  referenceType   String? // MAINTENANCE_ORDER, PURCHASE, ADJUSTMENT
  referenceId     String?
  notes           String?
  performedBy     String
  performedAt     DateTime            @default(now())

  sparePart SparePart @relation(fields: [sparePartId], references: [id])

  @@index([sparePartId])
  @@index([performedAt])
}

// Maintenance Audit Log
model MaintenanceAuditLog {
  id String @id @default(uuid())

  // What
  entityType String // ASSET, MAINTENANCE_ORDER, PM_SCHEDULE
  entityId   String
  action     String

  // Before/After
  previousState Json?
  newState      Json?
  changedFields String[]

  // Who
  userId   String
  userRole String?
  userName String?

  // When
  occurredAt DateTime @default(now())

  // Context
  ipAddress String?
  reason    String?

  @@index([entityType, entityId])
  @@index([userId])
  @@index([occurredAt])
}

// ============================================================================
// MAINTENANCE ENUMS
// ============================================================================

enum AssetStatus {
  IN_SERVICE
  OUT_OF_SERVICE
  MAINTENANCE
  SAFETY_HOLD
  QUALITY_HOLD
  PENDING_RETURN
  DECOMMISSIONED
}

enum AssetCriticality {
  A // Critical - Production stops
  B // Important - Workaround exists
  C // Standard - Minimal impact
}

enum ComponentStatus {
  ACTIVE
  WORN
  FAILED
  REPLACED
}

enum MeterType {
  HOURS
  CYCLES
  MILES
  UNITS_PRODUCED
}

enum MaintenanceOrderType {
  PM // Preventive Maintenance
  CORRECTIVE // Scheduled repair
  BREAKDOWN // Emergency repair
  INSPECTION // Planned inspection
  CALIBRATION // Calibration
  MODIFICATION // Asset modification
  SAFETY_RELATED // Safety-related work
  QUALITY_RELATED // Quality-triggered work
}

enum MaintenancePriority {
  EMERGENCY // Immediate response
  HIGH // Same day
  NORMAL // Within 3 days
  LOW // Within week
  SCHEDULED // Planned
}

enum MaintenanceOrderStatus {
  DRAFT // Being created
  PENDING_APPROVAL // Waiting approval
  APPROVED // Approved, not started
  SCHEDULED // Scheduled for work
  WAITING_PARTS // Parts on order
  IN_PROGRESS // Work underway
  COMPLETED // Work done, pending verification
  VERIFIED // Verified, pending return to service
  CLOSED // Fully closed
  CANCELLED // Cancelled
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum AttachmentType {
  PHOTO_BEFORE
  PHOTO_AFTER
  CHECKLIST
  PERMIT
  DOCUMENT
  TEST_RESULT
  SIGNATURE
  OTHER
}

enum PMIntervalType {
  TIME_BASED // Calendar days
  METER_BASED // Hours, miles, cycles
  CONDITION_BASED // Sensor/inspection trigger
  HYBRID // Whichever comes first
}

enum PMScheduleStatus {
  ACTIVE
  SUSPENDED
  COMPLETED
  CANCELLED
}

enum OverdueAction {
  ALERT // Send notification only
  ESCALATE // Escalate to manager
  BLOCK // Put asset out of service
}

enum PMComplianceStatus {
  CURRENT
  DUE_SOON
  OVERDUE
  SEVERELY_OVERDUE
}

enum DowntimeType {
  BREAKDOWN // Unplanned failure
  PLANNED_MAINTENANCE // Scheduled PM
  CORRECTIVE // Scheduled repair
  SETUP_CHANGEOVER // Setup time
  QUALITY_HOLD // Quality issue
  SAFETY_HOLD // Safety issue
  NO_WORK // No work scheduled
  OTHER // Other reason
}

enum PartTransactionType {
  RECEIVE // Received from supplier
  ISSUE // Issued to work order
  RETURN // Returned from work order
  ADJUST // Inventory adjustment
  TRANSFER // Transfer between locations
  SCRAP // Scrapped
}

// =============================================
// SALES & PRICING INTELLIGENCE MODELS
// =============================================

// Customer pricing tier & margin settings
model CustomerPricingTier {
  id               String    @id @default(uuid())
  customerId       String    @unique
  tierCode         String    // A, B, C, D
  marginFloor      Decimal   // Minimum margin % allowed
  marginTarget     Decimal   // Target margin %
  discountMaxPct   Decimal?  // Max discount from list
  paymentTerms     String?   // Net 30, etc.
  freightTerms     String?   // FOB, Prepaid, etc.
  creditLimit      Decimal?
  creditRating     String?
  isActive         Boolean   @default(true)
  effectiveFrom    DateTime  @default(now())
  effectiveUntil   DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  customer         Organization @relation("CustomerPricingTier", fields: [customerId], references: [id])
}

// Pricing recommendation record (audit trail)
model PricingRecommendation {
  id                String    @id @default(uuid())
  quoteLineId       String?
  rfqLineId         String?
  productCode       String?
  grade             String?
  form              String?
  dimensions        Json?     // { thickness, width, length }
  quantity          Decimal
  unit              String    @default("LB")
  
  // Cost components
  materialCost      Decimal?
  processingCost    Decimal?
  laborCost         Decimal?
  freightCost       Decimal?
  yieldLossCost     Decimal?
  packagingCost     Decimal?
  overheadCost      Decimal?
  totalCost         Decimal?
  
  // Pricing output
  recommendedPrice  Decimal
  minimumPrice      Decimal?  // Floor based on margin
  listPrice         Decimal?
  marginPct         Decimal?
  confidenceScore   Decimal?  // 0-100
  
  // Context
  customerId        String?
  customerTier      String?
  locationId        String?
  inventorySource   String?   // Stock, Mill, Transfer
  leadTimeDays      Int?
  
  // Alternatives
  alternatives      Json?     // [{ type, price, leadTime, description }]
  
  // Model info
  pricingModel      String?   // V1, V2, etc.
  modelInputs       Json?     // Full inputs for audit
  createdAt         DateTime  @default(now())
}

// Pricing override record
model PricingOverride {
  id               String    @id @default(uuid())
  quoteLineId      String?
  quoteId          String?
  originalPrice    Decimal
  overridePrice    Decimal
  originalMargin   Decimal?
  overrideMargin   Decimal?
  reason           String
  justification    String?
  
  // Approval
  requestedById    String
  approvedById     String?
  approvalStatus   ApprovalStatus @default(PENDING)
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  
  // Audit
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Quote acceptance record
model QuoteAcceptance {
  id               String    @id @default(uuid())
  quoteId          String    @unique
  acceptedAt       DateTime  @default(now())
  acceptedBy       String?   // Customer contact name
  acceptedByEmail  String?
  customerPO       String?
  termsAccepted    Boolean   @default(true)
  signatureData    String?   // Base64 or URL
  ipAddress        String?
  notes            String?
  createdAt        DateTime  @default(now())
}

// RFQ source tracking
model RFQSource {
  id               String    @id @default(uuid())
  rfqId            String    @unique
  sourceType       RFQSourceType
  sourceChannel    String?   // Email, Phone, Portal, EDI
  rawContent       String?   // Original email body, etc.
  parsedData       Json?     // AI-parsed structure
  parsingConfidence Decimal? // 0-100
  parseErrors      Json?     // Any parsing issues
  receivedAt       DateTime  @default(now())
  processedAt      DateTime?
  createdAt        DateTime  @default(now())
}

// Pricing analytics snapshot
model PricingAnalytics {
  id               String    @id @default(uuid())
  period           String    // YYYY-MM or YYYY-WW
  customerId       String?
  productCategory  String?
  locationId       String?
  
  // Metrics
  quotesCreated    Int       @default(0)
  quotesWon        Int       @default(0)
  quotesLost       Int       @default(0)
  winRate          Decimal?
  avgMarginQuoted  Decimal?
  avgMarginWon     Decimal?
  avgResponseHours Decimal?
  avgCycleTimeDays Decimal?
  totalValueQuoted Decimal?
  totalValueWon    Decimal?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@unique([period, customerId, productCategory, locationId])
}

enum RFQSourceType {
  EMAIL
  PHONE
  PORTAL
  EDI
  MANUAL
  ECOMMERCE
}

// ============================================================================
// DROP TAG ENGINE MODULE
// ============================================================================

// Drop Tag - Material Identity Tag
model DropTag {
  id                String          @id @default(uuid())
  dropTagId         String          @unique  // Human-friendly: DT-2026-001234
  tenantId          String?

  // Package Association (required)
  packageId         String
  package           Package         @relation(fields: [packageId], references: [id])

  // Shipment Association (assigned later)
  shipmentId        String?
  shipment          Shipment?       @relation(fields: [shipmentId], references: [id])
  listingId         String?
  listing           DropTagListing? @relation(fields: [listingId], references: [id])

  // Order Context
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id])
  orderLineId       String
  orderLine         OrderLine       @relation(fields: [orderLineId], references: [id])
  jobId             String?
  job               Job?            @relation(fields: [jobId], references: [id])

  // Customer Context
  customerId        String
  customer          Organization    @relation("DropTagCustomer", fields: [customerId], references: [id])
  customerPO        String?
  customerPartNo    String?

  // Material Identity (denormalized from inventory for immutability)
  division          String          // STEEL, ALUMINUM, PLASTICS, STAINLESS
  form              String          // ROUND_BAR, FLAT_BAR, PLATE, TUBE, SHEET
  grade             String          // 4140, 1018, 6061-T6, etc.
  specification     String?         // ASTM A108, AMS 2759, etc.
  condition         String?         // HR, CF, Q&T, ANNEALED
  dimensions        Json            // {od, id, width, thickness, etc.}
  lengthInches      Decimal?
  lengthFeet        Decimal?

  // Trace Identity
  heatNumber        String?
  lotId             String?
  inventoryLotId    String?
  supplierId        String?
  mtrDocId          String?         // Mill Test Report document ID
  cocDocId          String?         // Certificate of Conformance document ID

  // Quantity
  pieces            Int
  weightLbs         Decimal
  uom               String          @default("EA")  // EA, LB, FT, etc.

  // Processing Summary
  workCenters       String[]        // Work centers that processed this material
  operationsSummary String?         // Brief text summary of operations
  completedAt       DateTime?
  operatorIds       String[]        // User IDs of operators who processed

  // Handling Instructions
  bundleType        String?         // BANDED, BOXED, WRAPPED, CRATED
  packagingNotes    String?
  specialInstructions String?

  // Destination
  shipToAddress     Json?           // {name, line1, line2, city, state, zip}
  routeStop         Int?            // Stop sequence number
  requiredDate      DateTime?

  // Status & Lifecycle
  status            DropTagStatus   @default(DRAFT)
  version           Int             @default(1)
  reprintCount      Int             @default(0)
  lastReprintReason String?

  // Identifier Bindings (for RFID/etch future)
  identifiers       TagIdentifier[]

  // Timestamps & Audit
  createdBy         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  printedBy         String?
  printedAt         DateTime?
  appliedBy         String?
  appliedAt         DateTime?
  sealedAt          DateTime?
  voidedBy          String?
  voidedAt          DateTime?
  voidReason        String?

  // Trace Events
  traceEvents       TraceEvent[]

  @@index([packageId])
  @@index([shipmentId])
  @@index([orderId])
  @@index([customerId])
  @@index([heatNumber])
  @@index([status])
  @@index([dropTagId])
}

enum DropTagStatus {
  DRAFT             // Just created, not yet ready
  READY_TO_PRINT    // All validations passed, ready for printing
  PRINTED           // Tag printed but not yet applied
  APPLIED           // Tag physically applied to package
  SEALED            // Package sealed, identity immutable
  STAGED            // Package in staging area
  LOADED            // Package loaded on truck
  SHIPPED           // Truck departed
  DELIVERED         // Delivery confirmed
  VOID              // Voided (before ship only without escalation)
}

// Drop Tag Listing - Shipment Manifest
model DropTagListing {
  id                String              @id @default(uuid())
  listingId         String              @unique  // Human-friendly: DTL-2026-001234
  tenantId          String?

  // Shipment Association
  shipmentId        String
  shipment          Shipment            @relation(fields: [shipmentId], references: [id])

  // Location & Route
  originLocationId  String
  originLocation    Location            @relation("ListingOrigin", fields: [originLocationId], references: [id])
  routeId           String?
  loadId            String?

  // Stop Sequence
  stopSequence      Json                // [{stop: 1, customerId, shipTo, dropTagIds: [...]}]

  // Drop Tags
  dropTags          DropTag[]

  // Aggregated Totals (computed)
  totalPackages     Int                 @default(0)
  totalPieces       Int                 @default(0)
  totalWeightLbs    Decimal             @default(0)

  // Linked Documents
  cocBundleId       String?             // Combined CoC document bundle
  mtrBundleId       String?             // Combined MTR document bundle
  packingListDocId  String?             // Generated packing list

  // Status
  status            DropTagListingStatus @default(DRAFT)
  lockedAt          DateTime?
  lockedBy          String?

  // Timestamps
  createdBy         String
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  departedAt        DateTime?
  deliveredAt       DateTime?
  closedAt          DateTime?

  // Proof of Delivery
  podDocId          String?
  podSignature      String?
  podSignedBy       String?
  podSignedAt       DateTime?

  @@index([shipmentId])
  @@index([originLocationId])
  @@index([status])
}

enum DropTagListingStatus {
  DRAFT             // Being assembled
  READY             // All tags assigned, ready for print
  PRINTED           // Manifest printed
  LOADED            // All packages loaded
  DEPARTED          // Truck left
  DELIVERED         // All stops confirmed
  CLOSED            // Custody chain closed
}

// Package - Container for material with drop tags
model Package {
  id                String          @id @default(uuid())
  packageId         String          @unique  // Human-friendly: PKG-2026-001234
  tenantId          String?

  // Status
  status            PackageStatus   @default(OPEN)

  // Seal (required after SEALED)
  sealId            String?
  sealType          String?         // BAND, STRAP, SHRINK, LOCK
  sealAppliedBy     String?
  sealAppliedAt     DateTime?

  // Package Specification
  packageType       String          // BUNDLE, SKID, BOX, CRATE, DRUM
  dimensions        Json?           // {length, width, height, unit}
  tareWeightLbs     Decimal?
  grossWeightLbs    Decimal?
  netWeightLbs      Decimal?

  // Contents
  packageItems      PackageItem[]
  dropTags          DropTag[]

  // Location Tracking
  currentLocationId String?
  currentLocation   Location?       @relation("PackageLocation", fields: [currentLocationId], references: [id])
  currentBinId      String?

  // Order/Job Context
  orderId           String?
  order             Order?          @relation(fields: [orderId], references: [id])
  orderLineId       String?
  orderLine         OrderLine?      @relation(fields: [orderLineId], references: [id])
  jobId             String?
  job               Job?            @relation(fields: [jobId], references: [id])

  // QC Status
  qcStatus          PackageQCStatus @default(PENDING)
  qcReleasedBy      String?
  qcReleasedAt      DateTime?
  qcNotes           String?

  // Timestamps
  createdBy         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  packedAt          DateTime?
  stagedAt          DateTime?
  loadedAt          DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  @@index([status])
  @@index([orderId])
  @@index([currentLocationId])
  @@index([packageId])
}

enum PackageStatus {
  OPEN              // Being created
  PACKING           // Items being added
  READY_FOR_QC      // Awaiting QC inspection
  QC_RELEASED       // QC approved, ready for tagging
  QC_HOLD           // QC hold
  SEALED            // Sealed with tamper-evident seal
  STAGED            // In staging area
  LOADED            // On truck
  SHIPPED           // In transit
  DELIVERED         // At customer
}

enum PackageQCStatus {
  PENDING           // Not yet reviewed
  RELEASED          // Full release
  CONDITIONAL       // Released with conditions (needs approval)
  HOLD              // On hold, cannot proceed
  REJECTED          // Failed inspection
}

// Package Item - Individual material in a package
model PackageItem {
  id                String      @id @default(uuid())
  packageId         String
  package           Package     @relation(fields: [packageId], references: [id], onDelete: Cascade)

  // Material Reference
  inventoryLotId    String?
  coilId            String?
  heatNumber        String?

  // Material Details (snapshot)
  grade             String
  form              String
  dimensions        Json
  specification     String?
  condition         String?

  // Quantity
  pieces            Int
  weightLbs         Decimal
  lengthFeet        Decimal?

  // Piece Marks (if applicable)
  pieceMarks        String[]

  createdAt         DateTime    @default(now())

  @@index([packageId])
  @@index([inventoryLotId])
  @@index([coilId])
}

// Tag Identifier - For RFID/Etch future support
model TagIdentifier {
  id                String          @id @default(uuid())
  dropTagId         String
  dropTag           DropTag         @relation(fields: [dropTagId], references: [id], onDelete: Cascade)

  identifierType    IdentifierType
  identifierValue   String
  isPrimary         Boolean         @default(false)

  createdAt         DateTime        @default(now())

  @@unique([identifierType, identifierValue])
  @@index([dropTagId])
}

enum IdentifierType {
  BARCODE           // 1D barcode
  QR                // QR code
  RFID              // RFID tag
  ETCH              // Steel etching
  DATAMATRIX        // DataMatrix code
}

// Label Template - For printing drop tags
model LabelTemplate {
  id                String      @id @default(uuid())
  tenantId          String?

  name              String
  code              String      @unique  // BUNDLE_TAG, PIECE_TAG, etc.
  description       String?

  // Template Type
  templateType      String      // BUNDLE_TAG, PIECE_TAG, SKID_LABEL
  mediaType         String      // PAPER, PLASTIC, METAL_PLATE

  // Dimensions
  widthInches       Decimal
  heightInches      Decimal

  // Template Content (HTML or structured layout)
  templateContent   String

  // Barcode Settings
  barcodeType       String      @default("QR")  // QR, CODE128, CODE39
  barcodePosition   Json        // {x, y, width, height}

  // Customer Specific
  customerId        String?     // If specific to a customer

  // Status
  isActive          Boolean     @default(true)
  isDefault         Boolean     @default(false)

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([code])
  @@index([customerId])
  @@index([templateType])
}

// Trace Event - Immutable audit trail for drop tags
model TraceEvent {
  id                String      @id @default(uuid())
  eventId           String      @unique @default(uuid())

  // Event Classification
  eventType         String      // DROP_TAG_GENERATED, DROP_TAG_PRINTED, etc.
  eventCategory     String      // DROP_TAG, PACKAGE, SHIPMENT, LISTING

  // Actor
  actorUserId       String
  actorRole         String
  actorName         String?

  // Resource
  resourceType      String      // DropTag, Package, DropTagListing, Shipment
  resourceId        String

  // State Change
  previousState     String?
  newState          String?

  // Context
  locationId        String?
  stationId         String?     // Print station, scan station, etc.

  // Payload (full before/after snapshots)
  beforeSnapshot    Json?
  afterSnapshot     Json?
  metadata          Json?       // Additional context

  // Correlation
  correlationId     String?     // Links related events
  orderId           String?
  shipmentId        String?

  // Drop Tag Reference
  dropTagId         String?
  dropTag           DropTag?    @relation(fields: [dropTagId], references: [id])

  // Timestamp (immutable)
  occurredAt        DateTime    @default(now())

  // Immutability hash
  eventHash         String?     // SHA-256 of event content
  previousHash      String?     // Chain to previous event

  @@index([resourceType, resourceId])
  @@index([eventType])
  @@index([actorUserId])
  @@index([orderId])
  @@index([shipmentId])
  @@index([correlationId])
  @@index([occurredAt])
  @@index([dropTagId])
}

// Customer Tag Requirements - Customer-specific tagging rules
model CustomerTagRequirement {
  id                String      @id @default(uuid())
  customerId        String
  customer          Organization @relation("CustomerTagRequirements", fields: [customerId], references: [id])

  // Mandatory Fields
  requireHeatNumber     Boolean @default(true)
  requireMtrReference   Boolean @default(true)
  requireCocReference   Boolean @default(true)
  requirePieceMarks     Boolean @default(false)
  requireCustomerPartNo Boolean @default(false)
  requireCustomerPO     Boolean @default(true)
  requireSpecification  Boolean @default(true)
  requireCountryOfOrigin Boolean @default(false)

  // Label Format
  templateCode      String?     // Customer-specific template code
  barcodeType       String?     // Customer-required symbology
  includeQRCode     Boolean     @default(true)

  // Mixed Material Rules
  allowMixedHeat    Boolean     @default(false)
  allowMixedLength  Boolean     @default(false)
  requireCertPerHeat Boolean    @default(false)

  isActive          Boolean     @default(true)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@unique([customerId])
  @@index([customerId])
}

// ============================================================================
// EXTERNAL PARTNER API LAYER
// ============================================================================

enum PartnerType {
  CUSTOMER
  SUPPLIER
  CARRIER
  STRATEGIC
}

enum PartnerStatus {
  PENDING
  ACTIVE
  SUSPENDED
  REVOKED
}

enum PartnerTier {
  STANDARD
  STRATEGIC
  INTERNAL
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum WebhookStatus {
  ACTIVE
  PAUSED
  DISABLED
  FAILED
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
  RETRYING
}

// Partner - External organization integration profile
model Partner {
  id              String        @id @default(uuid())
  organizationId  String
  organization    Organization  @relation("PartnerOrganization", fields: [organizationId], references: [id])
  
  partnerType     PartnerType
  status          PartnerStatus @default(PENDING)
  tier            PartnerTier   @default(STANDARD)
  
  // Contact info
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  
  // Security
  ipAllowList     String[]      @default([])  // Empty = no restriction
  sandboxEnabled  Boolean       @default(true)
  productionEnabled Boolean     @default(false)
  
  // Rate limits (override defaults if set)
  rateLimitPerMin    Int?
  rateLimitPerHour   Int?
  burstLimit         Int?
  
  // Metadata
  notes           String?
  onboardedAt     DateTime?
  lastActiveAt    DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  apiKeys         PartnerApiKey[]
  webhooks        PartnerWebhook[]
  apiLogs         PartnerApiLog[]
  
  @@unique([organizationId, partnerType])
  @@index([partnerType])
  @@index([status])
  @@index([tier])
}

// PartnerApiKey - OAuth2 client credentials for partner authentication
model PartnerApiKey {
  id              String        @id @default(uuid())
  partnerId       String
  partner         Partner       @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Credentials (client_id is the key id, client_secret stored as hash)
  keyName         String        // Human-readable label, e.g. "Production Key"
  clientSecret    String        // bcrypt hashed secret
  
  // Scopes
  scopes          String[]      // e.g. ["rfq:write", "orders:read", "documents:read"]
  
  // Status
  status          ApiKeyStatus  @default(ACTIVE)
  environment     String        @default("sandbox")  // "sandbox" | "production"
  
  // Expiry
  expiresAt       DateTime?
  lastUsedAt      DateTime?
  
  // Security
  revokedAt       DateTime?
  revokedBy       String?       // User ID who revoked
  revokeReason    String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([partnerId])
  @@index([status])
  @@index([environment])
}

// PartnerWebhook - Webhook subscription for event notifications
model PartnerWebhook {
  id              String         @id @default(uuid())
  partnerId       String
  partner         Partner        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Endpoint
  url             String
  secret          String         // HMAC signing secret (encrypted at rest)
  
  // Subscription
  events          String[]       // e.g. ["order.confirmed", "shipment.dispatched"]
  
  // Status
  status          WebhookStatus  @default(ACTIVE)
  
  // Health tracking
  consecutiveFailures Int        @default(0)
  lastDeliveredAt     DateTime?
  lastFailedAt        DateTime?
  disabledAt          DateTime?
  disableReason       String?
  
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  // Relations
  deliveries      WebhookDelivery[]
  
  @@index([partnerId])
  @@index([status])
}

// WebhookDelivery - Individual webhook delivery attempt log
model WebhookDelivery {
  id              String                @id @default(uuid())
  webhookId       String
  webhook         PartnerWebhook        @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  // Event
  eventType       String
  eventId         String                // Unique event ID
  payload         Json
  
  // Delivery
  status          WebhookDeliveryStatus @default(PENDING)
  attempts        Int                   @default(0)
  maxAttempts     Int                   @default(5)
  
  // Response
  httpStatus      Int?
  responseBody    String?
  responseTimeMs  Int?
  errorMessage    String?
  
  // Timing
  nextRetryAt     DateTime?
  deliveredAt     DateTime?
  
  createdAt       DateTime              @default(now())
  
  @@index([webhookId])
  @@index([eventId])
  @@index([status])
  @@index([nextRetryAt])
}

// PartnerApiLog - Audit log for every partner API call
model PartnerApiLog {
  id              String        @id @default(uuid())
  partnerId       String
  partner         Partner       @relation(fields: [partnerId], references: [id])
  
  // Request
  method          String        // GET, POST, PUT, DELETE
  endpoint        String        // /api/v1/partner/customer/orders
  statusCode      Int
  
  // Metadata
  apiKeyId        String?
  ipAddress       String?
  userAgent       String?
  requestBody     Json?         // Sanitized, no secrets
  
  // Performance
  responseTimeMs  Int?
  
  // Error detail
  errorCode       String?
  errorMessage    String?
  
  // Data access tracking
  resourceType    String?       // "Order", "RFQ", "Shipment"
  resourceId      String?       // ID of accessed resource
  
  createdAt       DateTime      @default(now())
  
  @@index([partnerId])
  @@index([endpoint])
  @@index([statusCode])
  @@index([createdAt])
  @@index([apiKeyId])
}
