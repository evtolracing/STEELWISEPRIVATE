generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id             String     @id @default(uuid())
  code           String     @unique
  name           String
  type           OrgType
  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String     @default("USA")
  phone          String?
  email          String?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  coils          Coil[]
  documents      Document[]
  heats          Heat[]
  locations      Location[]
  ordersAsBuyer  Order[]    @relation("BuyerOrders")
  ordersAsSeller Order[]    @relation("SellerOrders")
  rfqs           RFQ[]      @relation("CustomerRFQs")
  users          User[]
  pricingTier    CustomerPricingTier? @relation("CustomerPricingTier")
}

model User {
  id               String               @id @default(uuid())
  email            String               @unique
  passwordHash     String
  firstName        String
  lastName         String
  role             UserRole
  organizationId   String
  homeLocationId   String?
  title            String?
  phone            String?
  avatarUrl        String?
  lastLoginAt      DateTime?
  mfaEnabled       Boolean              @default(false)
  isActive         Boolean              @default(true)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  createdCoils     Coil[]               @relation("CoilCreator")
  createdHeats     Heat[]               @relation("HeatCreator")
  assignedJobs     Job[]                @relation("JobAssignee")
  createdJobs      Job[]                @relation("JobCreator")
  movements        MaterialMovement[]
  orders           Order[]              @relation("OrderCreator")
  qcHolds          QCHold[]             @relation("HoldBy")
  resolvedHolds    QCHold[]             @relation("ResolvedBy")
  approvedTests    TestResult[]         @relation("ApprovedBy")
  testResults      TestResult[]         @relation("TestedBy")
  organization     Organization         @relation(fields: [organizationId], references: [id])
  homeLocation     Location?            @relation("UserHomeLocation", fields: [homeLocationId], references: [id])
  userRoles        UserRoleAssignment[]
  userLocations    UserLocation[]
  userDivisions    UserDivision[]
  auditLogs        AuditLog[]           @relation("AuditActor")
  approvalRequests ApprovalRequest[]    @relation("ApprovalRequester")
  approvalsMade    ApprovalDecision[]   @relation("ApprovalDecider")
}

// Role definition with permissions
model Role {
  id          String               @id @default(uuid())
  name        String               @unique
  displayName String
  description String?
  permissions Json // Array of permission strings
  isSystem    Boolean              @default(false)
  isActive    Boolean              @default(true)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  userRoles   UserRoleAssignment[]
}

// Many-to-many: User <-> Role
model UserRoleAssignment {
  id        String    @id @default(uuid())
  userId    String
  roleId    String
  grantedAt DateTime  @default(now())
  grantedBy String?
  expiresAt DateTime?
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

// User location assignments for ABAC scoping
model UserLocation {
  id         String   @id @default(uuid())
  userId     String
  locationId String
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
}

// User division assignments for ABAC scoping
model UserDivision {
  id         String   @id @default(uuid())
  userId     String
  divisionId String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  division   Division @relation(fields: [divisionId], references: [id], onDelete: Cascade)

  @@unique([userId, divisionId])
  @@index([userId])
  @@index([divisionId])
}

// Division model for organizational structure
model Division {
  id             String         @id @default(uuid())
  code           String         @unique
  name           String
  organizationId String
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  userDivisions  UserDivision[]
}

// Approval workflow tracking
model ApprovalRequest {
  id            String             @id @default(uuid())
  tenantId      String
  requestType   String // e.g., "QUOTE_DISCOUNT", "INVENTORY_ADJUST"
  resourceType  String
  resourceId    String
  requesterId   String
  status        ApprovalStatus     @default(PENDING)
  requestData   Json
  justification String?
  expiresAt     DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  requester     User               @relation("ApprovalRequester", fields: [requesterId], references: [id])
  decisions     ApprovalDecision[]

  @@index([tenantId, status])
  @@index([requesterId])
}

model ApprovalDecision {
  id        String          @id @default(uuid())
  requestId String
  deciderId String
  decision  DecisionType
  comments  String?
  createdAt DateTime        @default(now())
  request   ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  decider   User            @relation("ApprovalDecider", fields: [deciderId], references: [id])

  @@index([requestId])
}

// Audit log for security events
model AuditLog {
  id            String   @id @default(uuid())
  tenantId      String?
  category      String // AUTH, AUTHZ, DATA, FINANCIAL, WORKFLOW, SYSTEM
  eventType     String
  severity      String   @default("INFO")
  userId        String?
  targetUserId  String?
  resourceType  String?
  resourceId    String?
  action        String?
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  correlationId String?
  requestPath   String?
  requestMethod String?
  responseCode  Int?
  durationMs    Int?
  details       Json?
  fieldChanges  Json?
  timestamp     DateTime @default(now())

  user User? @relation("AuditActor", fields: [userId], references: [id])

  @@index([tenantId, timestamp])
  @@index([userId, timestamp])
  @@index([category, eventType])
  @@index([resourceType, resourceId])
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  ESCALATED
  EXPIRED
  CANCELLED
}

enum DecisionType {
  APPROVE
  REJECT
  ESCALATE
}

model Grade {
  id            String      @id @default(uuid())
  code          String      @unique
  name          String
  family        GradeFamily
  specStandard  String?
  chemistryMin  Json?
  chemistryMax  Json?
  tensileMin    Decimal?
  tensileMax    Decimal?
  yieldMin      Decimal?
  yieldMax      Decimal?
  elongationMin Decimal?
  hardnessMin   Decimal?
  hardnessMax   Decimal?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  coils         Coil[]
  heats         Heat[]
  orderLines    OrderLine[]
  products      Product[]
}

model Product {
  id           String      @id @default(uuid())
  sku          String      @unique
  name         String
  description  String?
  category     String?
  productType  ProductType
  form         ProductForm
  gradeId      String?
  specStandard String?
  thicknessMin Decimal?
  thicknessMax Decimal?
  widthMin     Decimal?
  widthMax     Decimal?
  basePriceCwt Decimal?
  priceUnit    PriceUnit   @default(CWT)
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  coils        Coil[]
  orderLines   OrderLine[]
  grade        Grade?      @relation(fields: [gradeId], references: [id])
}

model Heat {
  id              String       @id @default(uuid())
  heatNumber      String       @unique
  millId          String
  gradeId         String
  castDate        DateTime
  meltType        MeltType?
  castType        CastType?
  chemistry       Json?
  mechanicalProps Json?
  totalWeightLb   Decimal?
  status          HeatStatus   @default(ACTIVE)
  mtrDocumentId   String?
  createdAt       DateTime     @default(now())
  createdById     String
  updatedAt       DateTime     @updatedAt
  coils           Coil[]
  createdBy       User         @relation("HeatCreator", fields: [createdById], references: [id])
  grade           Grade        @relation(fields: [gradeId], references: [id])
  mill            Organization @relation(fields: [millId], references: [id])
  mtrDocument     Document?    @relation(fields: [mtrDocumentId], references: [id])
  testResults     TestResult[]
}

model Coil {
  id               String                @id @default(uuid())
  coilNumber       String                @unique
  heatId           String
  parentCoilId     String?
  productId        String?
  gradeId          String
  ownerId          String
  form             ProductForm
  thicknessIn      Decimal?
  widthIn          Decimal?
  lengthIn         Decimal?
  odIn             Decimal?
  idIn             Decimal?
  gauge            Int?
  grossWeightLb    Decimal
  netWeightLb      Decimal
  temper           String?
  finish           String?
  coating          String?
  coatingWeight    String?
  edgeCondition    EdgeCondition?
  status           CoilStatus            @default(AVAILABLE)
  qcStatus         QCStatus              @default(PENDING)
  holdCode         String?
  locationId       String?
  binLocation      String?
  unitCost         Decimal?
  landedCost       Decimal?
  originOrderId    String?
  createdAt        DateTime              @default(now())
  createdById      String
  updatedAt        DateTime              @updatedAt
  createdBy        User                  @relation("CoilCreator", fields: [createdById], references: [id])
  grade            Grade                 @relation(fields: [gradeId], references: [id])
  heat             Heat                  @relation(fields: [heatId], references: [id])
  location         Location?             @relation(fields: [locationId], references: [id])
  originOrder      Order?                @relation("OriginOrder", fields: [originOrderId], references: [id])
  owner            Organization          @relation(fields: [ownerId], references: [id])
  parentCoil       Coil?                 @relation("CoilParent", fields: [parentCoilId], references: [id])
  childCoils       Coil[]                @relation("CoilParent")
  product          Product?              @relation(fields: [productId], references: [id])
  documentLinks    DocumentLink[]
  inventory        Inventory?
  movements        MaterialMovement[]
  allocations      OrderLineAllocation[]
  qcHolds          QCHold[]
  testResults      TestResult[]
  workOrderInputs  WorkOrder[]           @relation("WorkOrderInput")
  workOrderOutputs WorkOrderOutput[]
}

model Location {
  id            String             @id @default(uuid())
  code          String             @unique
  name          String
  type          LocationType
  parentId      String?
  ownerId       String
  addressLine1  String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  lat           Decimal?
  lng           Decimal?
  maxWeightLb   Decimal?
  isOutdoor     Boolean            @default(false)
  hasCrane      Boolean            @default(false)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  coils         Coil[]
  inventories   Inventory[]
  owner         Organization       @relation(fields: [ownerId], references: [id])
  parent        Location?          @relation("LocationHierarchy", fields: [parentId], references: [id])
  children      Location[]         @relation("LocationHierarchy")
  movementsFrom MaterialMovement[] @relation("MovementFrom")
  movementsTo   MaterialMovement[] @relation("MovementTo")
  shipments     Shipment[]
  workCenters   WorkCenter[]
  usersHome     User[]             @relation("UserHomeLocation")
  userLocations UserLocation[]
  assets        Asset[]            @relation("AssetSite")
}

model Inventory {
  id            String    @id @default(uuid())
  coilId        String    @unique
  locationId    String
  qtyOnHand     Decimal
  qtyAvailable  Decimal
  qtyAllocated  Decimal   @default(0)
  qtyOnHold     Decimal   @default(0)
  unit          String    @default("LB")
  unitCost      Decimal?
  landedCost    Decimal?
  avgCost       Decimal?
  lastCountDate DateTime?
  lastMovement  DateTime?
  status        String    @default("ACTIVE")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  coil          Coil      @relation(fields: [coilId], references: [id])
  location      Location  @relation(fields: [locationId], references: [id])
}

model MaterialMovement {
  id             String       @id @default(uuid())
  coilId         String
  movementType   MovementType
  fromLocationId String?
  toLocationId   String?
  qtyMoved       Decimal
  unit           String       @default("LB")
  orderId        String?
  workOrderId    String?
  shipmentId     String?
  reasonCode     String?
  notes          String?
  createdAt      DateTime     @default(now())
  createdById    String
  coil           Coil         @relation(fields: [coilId], references: [id])
  createdBy      User         @relation(fields: [createdById], references: [id])
  fromLocation   Location?    @relation("MovementFrom", fields: [fromLocationId], references: [id])
  order          Order?       @relation(fields: [orderId], references: [id])
  shipment       Shipment?    @relation(fields: [shipmentId], references: [id])
  toLocation     Location?    @relation("MovementTo", fields: [toLocationId], references: [id])
  workOrder      WorkOrder?   @relation(fields: [workOrderId], references: [id])
}

model TestResult {
  id           String   @id @default(uuid())
  coilId       String?
  heatId       String
  testType     TestType
  testDate     DateTime
  results      Json
  specLimits   Json?
  passFail     PassFail
  equipmentId  String?
  labId        String?
  testedById   String
  approvedById String?
  certNumber   String?
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  approvedBy   User?    @relation("ApprovedBy", fields: [approvedById], references: [id])
  coil         Coil?    @relation(fields: [coilId], references: [id])
  heat         Heat     @relation(fields: [heatId], references: [id])
  testedBy     User     @relation("TestedBy", fields: [testedById], references: [id])
}

model QCHold {
  id              String       @id @default(uuid())
  coilId          String
  holdType        HoldType
  holdReason      String
  holdDate        DateTime     @default(now())
  holdById        String
  status          HoldStatus   @default(ACTIVE)
  disposition     Disposition?
  resolvedDate    DateTime?
  resolvedById    String?
  resolutionNotes String?
  ncrId           String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  coil            Coil         @relation(fields: [coilId], references: [id])
  holdBy          User         @relation("HoldBy", fields: [holdById], references: [id])
  resolvedBy      User?        @relation("ResolvedBy", fields: [resolvedById], references: [id])
}

model RFQ {
  id            String       @id @default(uuid())
  rfqNumber     String       @unique
  customerId    String
  status        RFQStatus    @default(DRAFT)
  contactName   String?
  contactEmail  String?
  contactPhone  String?
  requestedDate DateTime?
  notes         String?
  submittedAt   DateTime?
  expiresAt     DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  quotes        Quote[]
  customer      Organization @relation("CustomerRFQs", fields: [customerId], references: [id])
  lines         RFQLine[]
}

model RFQLine {
  id             String      @id @default(uuid())
  rfqId          String
  lineNumber     Int
  materialCode   String?
  division       String?
  productId      String?
  description    String?
  requestedQty   Decimal
  unit           String      @default("LB")
  specifications Json?
  notes          String?
  createdAt      DateTime    @default(now())
  quoteLines     QuoteLine[]
  rfq            RFQ         @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model Quote {
  id               String      @id @default(uuid())
  quoteNumber      String      @unique
  rfqId            String
  version          Int         @default(1)
  status           QuoteStatus @default(DRAFT)
  subtotal         Decimal?
  taxAmount        Decimal?
  freightAmount    Decimal?
  totalAmount      Decimal?
  currency         String      @default("USD")
  validFrom        DateTime    @default(now())
  validUntil       DateTime?
  paymentTerms     String?
  freightTerms     String?
  notes            String?
  internalNotes    String?
  createdById      String?
  sentAt           DateTime?
  acceptedAt       DateTime?
  convertedOrderId String?     @unique
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  convertedOrder   Order?      @relation("QuoteToOrder", fields: [convertedOrderId], references: [id])
  rfq              RFQ         @relation(fields: [rfqId], references: [id])
  lines            QuoteLine[]
}

model QuoteLine {
  id            String   @id @default(uuid())
  quoteId       String
  rfqLineId     String?
  lineNumber    Int
  productId     String?
  description   String?
  quantity      Decimal
  unit          String   @default("LB")
  unitPrice     Decimal?
  priceUnit     String   @default("CWT")
  extendedPrice Decimal?
  leadTimeDays  Int?
  notes         String?
  createdAt     DateTime @default(now())
  quote         Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  rfqLine       RFQLine? @relation(fields: [rfqLineId], references: [id])
}

model WorkCenter {
  id           String   @id @default(uuid())
  code         String   @unique
  name         String
  locationId   String
  type         String?
  capabilities String[]
  capacity     Json?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  jobs         Job[]
  location     Location @relation(fields: [locationId], references: [id])
  assets       Asset[]  @relation("AssetWorkCenter")
}

model Job {
  id               String      @id @default(uuid())
  jobNumber        String      @unique
  orderId          String?
  orderLineId      String?
  workCenterId     String?
  workOrderId      String?
  assignedToId     String?
  createdById      String?
  status           JobStatus   @default(SCHEDULED)
  operationType    String?
  priority         Int         @default(3)
  scheduledStart   DateTime?
  scheduledEnd     DateTime?
  actualStart      DateTime?
  actualEnd        DateTime?
  inputWeightLb    Decimal?
  outputWeightLb   Decimal?
  scrapWeightLb    Decimal?
  operatorId       String?
  instructions     String?
  notes            String?
  shippingCarrier  String?
  trackingNumber   String?
  shippedAt        DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  hasCustomRouting Boolean     @default(false)
  recipeId         String?
  recipeVersion    Int?
  assignedTo       User?       @relation("JobAssignee", fields: [assignedToId], references: [id])
  createdBy        User?       @relation("JobCreator", fields: [createdById], references: [id])
  order            Order?      @relation(fields: [orderId], references: [id])
  recipe           BomRecipe?  @relation("JobRecipe", fields: [recipeId], references: [id])
  workCenter       WorkCenter? @relation(fields: [workCenterId], references: [id])

  @@index([recipeId])
}

model Order {
  id            String             @id @default(uuid())
  orderNumber   String             @unique
  orderType     OrderType
  buyerId       String?
  sellerId      String?
  shipToAddress String?
  shipToCity    String?
  shipToState   String?
  shipToZip     String?
  orderDate     DateTime           @default(now())
  requiredDate  DateTime?
  promisedDate  DateTime?
  expireDate    DateTime?
  status        OrderStatus        @default(DRAFT)
  subtotal      Decimal?
  taxAmount     Decimal?
  freightAmount Decimal?
  totalAmount   Decimal?
  currency      String             @default("USD")
  paymentTerms  String?
  freightTerms  FreightTerms?
  poReference   String?
  notes         String?
  createdAt     DateTime           @default(now())
  createdById   String
  updatedAt     DateTime           @updatedAt
  originCoils   Coil[]             @relation("OriginOrder")
  invoices      Invoice[]
  jobs          Job[]
  movements     MaterialMovement[]
  buyer         Organization?      @relation("BuyerOrders", fields: [buyerId], references: [id])
  createdBy     User               @relation("OrderCreator", fields: [createdById], references: [id])
  seller        Organization?      @relation("SellerOrders", fields: [sellerId], references: [id])
  lines         OrderLine[]
  fromQuote     Quote?             @relation("QuoteToOrder")
  shipments     Shipment[]
}

model OrderLine {
  id            String                @id @default(uuid())
  orderId       String
  lineNumber    Int
  productId     String?
  gradeId       String?
  description   String?
  thicknessIn   Decimal?
  widthIn       Decimal?
  lengthIn      Decimal?
  finish        String?
  coating       String?
  qtyOrdered    Decimal
  qtyShipped    Decimal               @default(0)
  qtyReceived   Decimal               @default(0)
  unit          String                @default("LB")
  unitPrice     Decimal?
  priceUnit     PriceUnit             @default(CWT)
  discountPct   Decimal?
  extendedPrice Decimal?
  lineStatus    LineStatus            @default(OPEN)
  notes         String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  grade         Grade?                @relation(fields: [gradeId], references: [id])
  order         Order                 @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product?              @relation(fields: [productId], references: [id])
  allocations   OrderLineAllocation[]
  shipmentItems ShipmentItem[]
}

model OrderLineAllocation {
  id           String    @id @default(uuid())
  orderLineId  String
  coilId       String
  qtyAllocated Decimal
  allocatedAt  DateTime  @default(now())
  coil         Coil      @relation(fields: [coilId], references: [id])
  orderLine    OrderLine @relation(fields: [orderLineId], references: [id], onDelete: Cascade)
}

model WorkOrder {
  id             String             @id @default(uuid())
  woNumber       String             @unique
  woType         WOType
  status         WOStatus           @default(DRAFT)
  sourceCoilId   String
  lineId         String?
  salesOrderId   String?
  priority       Int                @default(3)
  scheduledDate  DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  slitPattern    Json?
  inputWeightLb  Decimal?
  outputWeightLb Decimal?
  scrapWeightLb  Decimal?
  yieldPct       Decimal?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  movements      MaterialMovement[]
  sourceCoil     Coil               @relation("WorkOrderInput", fields: [sourceCoilId], references: [id])
  outputs        WorkOrderOutput[]
}

model WorkOrderOutput {
  id           String    @id @default(uuid())
  workOrderId  String
  outputCoilId String
  sequence     Int
  targetWidth  Decimal?
  actualWidth  Decimal?
  actualWeight Decimal?
  destination  String?
  createdAt    DateTime  @default(now())
  outputCoil   Coil      @relation(fields: [outputCoilId], references: [id])
  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
}

model Shipment {
  id             String             @id @default(uuid())
  shipmentNumber String             @unique
  orderId        String
  fromLocationId String
  carrierId      String?
  carrierName    String?
  truckNumber    String?
  driverName     String?
  driverPhone    String?
  status         ShipmentStatus     @default(PENDING)
  scheduledDate  DateTime?
  shippedAt      DateTime?
  deliveredAt    DateTime?
  totalWeightLb  Decimal?
  bolNumber      String?
  podCaptured    Boolean            @default(false)
  podImageUrl    String?
  podSignature   String?
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  movements      MaterialMovement[]
  fromLocation   Location           @relation(fields: [fromLocationId], references: [id])
  order          Order              @relation(fields: [orderId], references: [id])
  items          ShipmentItem[]
  stops          ShipmentStop[]
}

model ShipmentItem {
  id          String    @id @default(uuid())
  shipmentId  String
  orderLineId String
  qtyShipped  Decimal
  weightLb    Decimal?
  createdAt   DateTime  @default(now())
  orderLine   OrderLine @relation(fields: [orderLineId], references: [id])
  shipment    Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
}

model ShipmentStop {
  id            String    @id @default(uuid())
  shipmentId    String
  stopNumber    Int
  address       String
  city          String?
  state         String?
  zipCode       String?
  scheduledTime DateTime?
  arrivedAt     DateTime?
  departedAt    DateTime?
  notes         String?
  createdAt     DateTime  @default(now())
  shipment      Shipment  @relation(fields: [shipmentId], references: [id], onDelete: Cascade)
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  orderId       String
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime?
  subtotal      Decimal
  taxAmount     Decimal       @default(0)
  freightAmount Decimal       @default(0)
  totalAmount   Decimal
  paidAmount    Decimal       @default(0)
  status        InvoiceStatus @default(DRAFT)
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  order         Order         @relation(fields: [orderId], references: [id])
  payments      Payment[]
}

model Payment {
  id              String   @id @default(uuid())
  invoiceId       String
  amount          Decimal
  paymentDate     DateTime @default(now())
  paymentMethod   String?
  referenceNumber String?
  notes           String?
  createdAt       DateTime @default(now())
  invoice         Invoice  @relation(fields: [invoiceId], references: [id])
}

model Document {
  id             String         @id @default(uuid())
  documentType   DocumentType
  documentNumber String?
  title          String?
  fileName       String
  fileType       String?
  fileSizeBytes  Int?
  storagePath    String
  checksum       String?
  extractedData  Json?
  isVerified     Boolean        @default(false)
  verifiedById   String?
  verifiedAt     DateTime?
  issueDate      DateTime?
  expiryDate     DateTime?
  ownerId        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  owner          Organization?  @relation(fields: [ownerId], references: [id])
  links          DocumentLink[]
  heats          Heat[]
}

model DocumentLink {
  id         String   @id @default(uuid())
  documentId String
  entityType String
  entityId   String
  linkType   String   @default("PRIMARY")
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  coil       Coil     @relation(fields: [entityId], references: [id], map: "document_coil_link")
}

model CommodityPrice {
  id            String   @id @default(uuid())
  indexCode     String
  indexName     String
  price         Decimal
  unit          String
  effectiveDate DateTime
  source        String?
  createdAt     DateTime @default(now())

  @@index([indexCode, effectiveDate])
}

model BomRecipe {
  id           String          @id @default(uuid())
  name         String
  code         String
  materialCode String?
  commodity    String?
  form         String?
  grade        String?
  thicknessMin Decimal?
  thicknessMax Decimal?
  division     String?
  version      Int             @default(1)
  status       BomRecipeStatus @default(DRAFT)
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  operations   BomOperation[]
  jobs         Job[]           @relation("JobRecipe")

  @@index([code, version])
  @@index([status])
  @@index([materialCode])
  @@index([commodity, form, grade])
}

model BomOperation {
  id                      String    @id @default(uuid())
  recipeId                String
  sequence                Int
  name                    String
  workCenterType          String
  estimatedMachineMinutes Int       @default(0)
  estimatedLaborMinutes   Int       @default(0)
  setupMinutes            Int       @default(0)
  parameters              Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  recipe                  BomRecipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId, sequence])
}

enum OrgType {
  MILL
  SERVICE_CENTER
  DISTRIBUTOR
  BROKER
  FABRICATOR
  OEM
}

enum UserRole {
  // System Roles
  SUPER_ADMIN
  TENANT_OWNER

  // Executive Roles
  EXECUTIVE
  CFO
  COO
  CIO

  // Division/Branch Roles
  DIVISION_DIRECTOR
  BRANCH_MANAGER

  // Sales Roles
  SALES_DIRECTOR
  SALES_REP
  CSR
  ESTIMATOR
  CREDIT_MANAGER

  // Operations Roles
  OPS_MANAGER
  PRODUCTION_MANAGER
  SCHEDULER
  INVENTORY_MANAGER
  BUYER
  WORKCENTER_LEAD

  // Shop Floor Roles
  OPERATOR_SAW
  OPERATOR_ROUTER
  OPERATOR_SHEAR
  OPERATOR_PLASMA
  OPERATOR_GENERAL
  MATERIAL_HANDLER
  RECEIVING_CLERK
  SHIPPING_COORDINATOR
  PACKAGING_LEAD

  // Quality Roles
  QC_MANAGER
  QC_INSPECTOR

  // Support Roles
  MAINTENANCE_MANAGER
  INTEGRATION_ADMIN
  DATA_ANALYST
  SUPPORT_AGENT
  AUDITOR

  // External Portal Roles
  CUSTOMER_ADMIN
  CUSTOMER_BUYER
  CUSTOMER_VIEWER
  SUPPLIER_USER
  CARRIER_USER

  // Legacy (for backward compatibility)
  ADMIN
  MILL_OPERATOR
  SERVICE_CENTER
  SALES
  QUALITY
  LOGISTICS
  FINANCE
  VIEWER
}

enum GradeFamily {
  CARBON
  ALLOY
  STAINLESS
  TOOL
  HSLA
}

enum ProductType {
  FLAT
  LONG
  TUBE
  STRUCTURAL
}

enum ProductForm {
  COIL
  SHEET
  PLATE
  BAR
  TUBE
  BEAM
  REBAR
  WIRE
}

enum PriceUnit {
  CWT
  LB
  TON
  EACH
  LF
}

enum MeltType {
  BOF
  EAF
  AOD
}

enum CastType {
  CONTINUOUS
  INGOT
}

enum HeatStatus {
  ACTIVE
  CONSUMED
  ARCHIVED
}

enum EdgeCondition {
  MILL
  SLIT
  TRIMMED
}

enum CoilStatus {
  AVAILABLE
  ALLOCATED
  IN_PROCESS
  HOLD
  SHIPPED
  CONSUMED
}

enum QCStatus {
  PENDING
  PASSED
  FAILED
  HOLD
}

enum LocationType {
  WAREHOUSE
  YARD
  RACK
  BIN
  FLOOR
}

enum MovementType {
  RECEIVE
  SHIP
  TRANSFER
  ADJUST
  PROCESS
  CONSUME
  SCRAP
  COUNT
}

enum TestType {
  CHEMISTRY
  MECHANICAL
  DIMENSIONAL
  SURFACE
  COATING
  OTHER
}

enum PassFail {
  PASS
  FAIL
  CONDITIONAL
}

enum HoldType {
  QUALITY
  CUSTOMER
  PENDING_TEST
  DAMAGE
  DISPUTE
  OTHER
}

enum HoldStatus {
  ACTIVE
  RELEASED
  SCRAPPED
  RETURNED
}

enum Disposition {
  USE_AS_IS
  REWORK
  SCRAP
  RETURN
  SELL_SECONDARY
  PENDING
}

enum RFQStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  QUOTED
  ACCEPTED
  REJECTED
  EXPIRED
  WITHDRAWN
}

enum QuoteStatus {
  DRAFT
  PENDING_APPROVAL
  SENT
  COUNTERED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum JobStatus {
  ORDERED
  SCHEDULED
  IN_PROCESS
  WAITING_QC
  PACKAGING
  READY_TO_SHIP
  SHIPPED
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum OrderType {
  RFQ
  QUOTE
  SO
  PO
  RETURN
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  PARTIAL
  COMPLETE
  CANCELLED
  HOLD
}

enum FreightTerms {
  PREPAID
  COLLECT
  THIRD_PARTY
}

enum LineStatus {
  OPEN
  PARTIAL
  COMPLETE
  CANCELLED
}

enum WOType {
  SLIT
  CTL
  BLANK
  LEVELCUT
  MULTIBLANKING
  SHEAR
}

enum WOStatus {
  DRAFT
  READY
  IN_PROGRESS
  QC_HOLD
  COMPLETE
  CANCELLED
}

enum ShipmentStatus {
  PENDING
  LOADING
  IN_TRANSIT
  DELIVERED
  EXCEPTION
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum DocumentType {
  MTR
  CERT
  BOL
  POD
  INVOICE
  SPEC
  COA
  MSDS
  DRAWING
  OTHER
}

enum BomRecipeStatus {
  DRAFT
  REVIEW
  ACTIVE
  DEPRECATED
  ARCHIVED
}

// ============================================================================
// MAINTENANCE & RELIABILITY MODULE
// ============================================================================

model Asset {
  id          String  @id @default(uuid())
  assetNumber String  @unique
  name        String
  description String?
  assetTypeId String

  // Hierarchy
  parentAssetId String?
  siteId        String // Location reference
  areaCode      String?
  workCenterId  String?

  // Equipment Details
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime?
  installDate       DateTime?
  warrantyExpires   DateTime?
  expectedLifeYears Int?
  replacementCost   Decimal?

  // Criticality
  criticality    AssetCriticality @default(C)
  safetyRelated  Boolean          @default(false)
  qualityRelated Boolean          @default(false)

  // Status
  status          AssetStatus @default(IN_SERVICE)
  statusReason    String?
  statusChangedAt DateTime?
  statusChangedBy String?

  // Metering
  currentHours  Decimal?
  currentCycles Int?
  currentMiles  Decimal?

  // PM Information
  lastPMDate         DateTime?
  nextPMDueDate      DateTime?
  pmComplianceStatus PMComplianceStatus?

  // Certification
  certificationRequired Boolean   @default(false)
  certificationExpires  DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assetType   AssetType   @relation(fields: [assetTypeId], references: [id])
  parentAsset Asset?      @relation("AssetHierarchy", fields: [parentAssetId], references: [id])
  childAssets Asset[]     @relation("AssetHierarchy")
  site        Location    @relation("AssetSite", fields: [siteId], references: [id])
  workCenter  WorkCenter? @relation("AssetWorkCenter", fields: [workCenterId], references: [id])

  components        AssetComponent[]
  meterReadings     MeterReading[]
  maintenanceOrders MaintenanceOrder[]
  pmSchedules       PMSchedule[]
  downtimeRecords   DowntimeRecord[]
  spareParts        SparePart[]

  @@index([assetNumber])
  @@index([siteId])
  @@index([status])
  @@index([criticality])
  @@index([assetTypeId])
}

model AssetType {
  id                 String           @id @default(uuid())
  code               String           @unique
  name               String
  category           String? // SAW, ROUTER, FORKLIFT, CRANE, etc.
  description        String?
  defaultCriticality AssetCriticality @default(C)
  pmTemplateId       String?

  // Default Intervals
  defaultPMIntervalDays  Int?
  defaultPMIntervalHours Int?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assets      Asset[]
  pmTemplates PMTemplate[]

  @@index([code])
  @@index([category])
}

model AssetComponent {
  id                String          @id @default(uuid())
  assetId           String
  name              String
  partNumber        String?
  serialNumber      String?
  manufacturer      String?
  installDate       DateTime?
  warrantyExpires   DateTime?
  expectedLifeHours Int?
  currentHours      Decimal?
  status            ComponentStatus @default(ACTIVE)
  notes             String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
}

model MeterReading {
  id          String    @id @default(uuid())
  assetId     String
  meterType   MeterType
  reading     Decimal
  readingDate DateTime  @default(now())
  recordedBy  String
  source      String? // MANUAL, AUTOMATIC, IMPORT
  notes       String?

  createdAt DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, meterType])
  @@index([readingDate])
}

// Work Order for Maintenance
model MaintenanceOrder {
  id       String @id @default(uuid())
  woNumber String @unique
  assetId  String

  // Type & Priority
  type     MaintenanceOrderType
  priority MaintenancePriority  @default(NORMAL)

  // Description
  title       String
  description String?
  problemCode String?
  failureCode String?

  // Scheduling
  status         MaintenanceOrderStatus @default(DRAFT)
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  estimatedHours Decimal?

  // Execution
  actualStart DateTime?
  actualEnd   DateTime?
  actualHours Decimal?

  // Assignment
  assignedToId String?
  assignedTeam String?

  // Safety
  lotoRequired          Boolean @default(false)
  permitRequired        Boolean @default(false)
  hotWorkRequired       Boolean @default(false)
  confinedSpaceRequired Boolean @default(false)
  safetyRelated         Boolean @default(false)

  // Linked Records
  pmScheduleId     String?
  pmTemplateId     String?
  downtimeRecordId String?
  stopWorkId       String?
  ncrId            String?
  spcViolationId   String?

  // Verification
  requiresFirstArticle Boolean  @default(false)
  firstArticlePassed   Boolean?
  testRunPassed        Boolean?

  // Approval
  submittedAt DateTime?
  submittedBy String?
  approvedAt  DateTime?
  approvedBy  String?

  // Completion
  completedAt     DateTime?
  completedBy     String?
  completionNotes String?

  // Verification & Closure
  verifiedAt        DateTime?
  verifiedBy        String?
  verificationNotes String?
  closedAt          DateTime?
  closedBy          String?

  createdAt DateTime @default(now())
  createdBy String?
  updatedAt DateTime @updatedAt

  // Relations
  asset          Asset           @relation(fields: [assetId], references: [id])
  pmSchedule     PMSchedule?     @relation(fields: [pmScheduleId], references: [id])
  pmTemplate     PMTemplate?     @relation(fields: [pmTemplateId], references: [id])
  downtimeRecord DowntimeRecord? @relation(fields: [downtimeRecordId], references: [id])

  tasks       MaintenanceTask[]
  parts       MaintenanceOrderPart[]
  labor       MaintenanceOrderLabor[]
  attachments MaintenanceAttachment[]

  @@index([woNumber])
  @@index([assetId])
  @@index([status])
  @@index([type])
  @@index([priority])
  @@index([scheduledStart])
}

model MaintenanceTask {
  id                 String     @id @default(uuid())
  maintenanceOrderId String
  sequence           Int
  description        String
  estimatedMinutes   Int?
  actualMinutes      Int?
  status             TaskStatus @default(PENDING)
  completedAt        DateTime?
  completedBy        String?
  notes              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId, sequence])
}

model MaintenanceOrderPart {
  id                 String    @id @default(uuid())
  maintenanceOrderId String
  sparePartId        String?
  partNumber         String
  partDescription    String?
  quantityRequired   Decimal
  quantityUsed       Decimal   @default(0)
  unitCost           Decimal?
  issuedAt           DateTime?
  issuedBy           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)
  sparePart        SparePart?       @relation(fields: [sparePartId], references: [id])

  @@index([maintenanceOrderId])
}

model MaintenanceOrderLabor {
  id                 String    @id @default(uuid())
  maintenanceOrderId String
  technicianId       String
  technicianName     String
  startTime          DateTime
  endTime            DateTime?
  regularHours       Decimal   @default(0)
  overtimeHours      Decimal   @default(0)
  laborRate          Decimal?
  notes              String?

  createdAt DateTime @default(now())

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId])
}

model MaintenanceAttachment {
  id                 String         @id @default(uuid())
  maintenanceOrderId String
  type               AttachmentType
  fileName           String
  fileType           String?
  fileSizeBytes      Int?
  storagePath        String
  description        String?
  uploadedAt         DateTime       @default(now())
  uploadedBy         String

  maintenanceOrder MaintenanceOrder @relation(fields: [maintenanceOrderId], references: [id], onDelete: Cascade)

  @@index([maintenanceOrderId])
}

// PM Templates
model PMTemplate {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?
  assetTypeId String?

  // Default Schedule
  intervalType  PMIntervalType
  intervalValue Int
  intervalUnit  String? // DAYS, HOURS, MILES, CYCLES

  // Trigger Settings
  triggerOnHours     Boolean @default(false)
  triggerOnCalendar  Boolean @default(true)
  triggerOnCondition Boolean @default(false)
  conditionThreshold Json?

  // Default Task List
  taskList Json? // Array of task templates

  // Default Parts
  defaultParts Json? // Array of part requirements

  // Safety
  lotoRequired   Boolean  @default(false)
  permitRequired Boolean  @default(false)
  estimatedHours Decimal?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  assetType         AssetType?         @relation(fields: [assetTypeId], references: [id])
  pmSchedules       PMSchedule[]
  maintenanceOrders MaintenanceOrder[]

  @@index([code])
  @@index([assetTypeId])
}

model PMSchedule {
  id           String  @id @default(uuid())
  assetId      String
  pmTemplateId String?

  // Schedule
  intervalType  PMIntervalType
  intervalValue Int
  intervalUnit  String?

  // Trigger Tracking
  lastCompletedDate  DateTime?
  lastCompletedHours Decimal?
  nextDueDate        DateTime?
  nextDueHours       Decimal?

  // Overdue Handling
  overdueAction        OverdueAction @default(ALERT)
  overdueThresholdDays Int?

  // Status
  status PMScheduleStatus @default(ACTIVE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset             Asset              @relation(fields: [assetId], references: [id], onDelete: Cascade)
  pmTemplate        PMTemplate?        @relation(fields: [pmTemplateId], references: [id])
  maintenanceOrders MaintenanceOrder[]

  @@index([assetId])
  @@index([nextDueDate])
  @@index([status])
}

// Downtime Tracking
model DowntimeRecord {
  id      String @id @default(uuid())
  assetId String

  // Timing
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?

  // Classification
  type              DowntimeType
  reasonCode        String?
  reasonDescription String?

  // Impact
  impactedJobs        String[] // Array of job IDs
  productionLossUnits Decimal?
  estimatedCost       Decimal?

  // Reporting
  reportedBy String
  reportedAt DateTime @default(now())
  symptoms   String?

  // Resolution
  resolvedBy      String?
  resolutionNotes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset             Asset              @relation(fields: [assetId], references: [id])
  maintenanceOrders MaintenanceOrder[]

  @@index([assetId])
  @@index([startTime])
  @@index([type])
}

// Spare Parts Inventory
model SparePart {
  id           String  @id @default(uuid())
  partNumber   String  @unique
  name         String
  description  String?
  category     String?
  manufacturer String?

  // Inventory
  quantityOnHand   Decimal @default(0)
  quantityReserved Decimal @default(0)
  quantityOnOrder  Decimal @default(0)
  reorderPoint     Int?
  reorderQuantity  Int?
  unitOfMeasure    String  @default("EACH")

  // Cost
  unitCost          Decimal?
  lastPurchasePrice Decimal?
  lastPurchaseDate  DateTime?

  // Location
  storageLocation String?
  binNumber       String?

  // Asset Links
  assetId       String? // Optional: specific asset
  assetTypeCode String? // Or: applies to asset type

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  asset        Asset?                 @relation(fields: [assetId], references: [id])
  orderParts   MaintenanceOrderPart[]
  transactions SparePartTransaction[]

  @@index([partNumber])
  @@index([category])
  @@index([assetId])
}

model SparePartTransaction {
  id              String              @id @default(uuid())
  sparePartId     String
  transactionType PartTransactionType
  quantity        Decimal
  unitCost        Decimal?
  referenceType   String? // MAINTENANCE_ORDER, PURCHASE, ADJUSTMENT
  referenceId     String?
  notes           String?
  performedBy     String
  performedAt     DateTime            @default(now())

  sparePart SparePart @relation(fields: [sparePartId], references: [id])

  @@index([sparePartId])
  @@index([performedAt])
}

// Maintenance Audit Log
model MaintenanceAuditLog {
  id String @id @default(uuid())

  // What
  entityType String // ASSET, MAINTENANCE_ORDER, PM_SCHEDULE
  entityId   String
  action     String

  // Before/After
  previousState Json?
  newState      Json?
  changedFields String[]

  // Who
  userId   String
  userRole String?
  userName String?

  // When
  occurredAt DateTime @default(now())

  // Context
  ipAddress String?
  reason    String?

  @@index([entityType, entityId])
  @@index([userId])
  @@index([occurredAt])
}

// ============================================================================
// MAINTENANCE ENUMS
// ============================================================================

enum AssetStatus {
  IN_SERVICE
  OUT_OF_SERVICE
  MAINTENANCE
  SAFETY_HOLD
  QUALITY_HOLD
  PENDING_RETURN
  DECOMMISSIONED
}

enum AssetCriticality {
  A // Critical - Production stops
  B // Important - Workaround exists
  C // Standard - Minimal impact
}

enum ComponentStatus {
  ACTIVE
  WORN
  FAILED
  REPLACED
}

enum MeterType {
  HOURS
  CYCLES
  MILES
  UNITS_PRODUCED
}

enum MaintenanceOrderType {
  PM // Preventive Maintenance
  CORRECTIVE // Scheduled repair
  BREAKDOWN // Emergency repair
  INSPECTION // Planned inspection
  CALIBRATION // Calibration
  MODIFICATION // Asset modification
  SAFETY_RELATED // Safety-related work
  QUALITY_RELATED // Quality-triggered work
}

enum MaintenancePriority {
  EMERGENCY // Immediate response
  HIGH // Same day
  NORMAL // Within 3 days
  LOW // Within week
  SCHEDULED // Planned
}

enum MaintenanceOrderStatus {
  DRAFT // Being created
  PENDING_APPROVAL // Waiting approval
  APPROVED // Approved, not started
  SCHEDULED // Scheduled for work
  WAITING_PARTS // Parts on order
  IN_PROGRESS // Work underway
  COMPLETED // Work done, pending verification
  VERIFIED // Verified, pending return to service
  CLOSED // Fully closed
  CANCELLED // Cancelled
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum AttachmentType {
  PHOTO_BEFORE
  PHOTO_AFTER
  CHECKLIST
  PERMIT
  DOCUMENT
  TEST_RESULT
  SIGNATURE
  OTHER
}

enum PMIntervalType {
  TIME_BASED // Calendar days
  METER_BASED // Hours, miles, cycles
  CONDITION_BASED // Sensor/inspection trigger
  HYBRID // Whichever comes first
}

enum PMScheduleStatus {
  ACTIVE
  SUSPENDED
  COMPLETED
  CANCELLED
}

enum OverdueAction {
  ALERT // Send notification only
  ESCALATE // Escalate to manager
  BLOCK // Put asset out of service
}

enum PMComplianceStatus {
  CURRENT
  DUE_SOON
  OVERDUE
  SEVERELY_OVERDUE
}

enum DowntimeType {
  BREAKDOWN // Unplanned failure
  PLANNED_MAINTENANCE // Scheduled PM
  CORRECTIVE // Scheduled repair
  SETUP_CHANGEOVER // Setup time
  QUALITY_HOLD // Quality issue
  SAFETY_HOLD // Safety issue
  NO_WORK // No work scheduled
  OTHER // Other reason
}

enum PartTransactionType {
  RECEIVE // Received from supplier
  ISSUE // Issued to work order
  RETURN // Returned from work order
  ADJUST // Inventory adjustment
  TRANSFER // Transfer between locations
  SCRAP // Scrapped
}

// =============================================
// SALES & PRICING INTELLIGENCE MODELS
// =============================================

// Customer pricing tier & margin settings
model CustomerPricingTier {
  id               String    @id @default(uuid())
  customerId       String    @unique
  tierCode         String    // A, B, C, D
  marginFloor      Decimal   // Minimum margin % allowed
  marginTarget     Decimal   // Target margin %
  discountMaxPct   Decimal?  // Max discount from list
  paymentTerms     String?   // Net 30, etc.
  freightTerms     String?   // FOB, Prepaid, etc.
  creditLimit      Decimal?
  creditRating     String?
  isActive         Boolean   @default(true)
  effectiveFrom    DateTime  @default(now())
  effectiveUntil   DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  customer         Organization @relation("CustomerPricingTier", fields: [customerId], references: [id])
}

// Pricing recommendation record (audit trail)
model PricingRecommendation {
  id                String    @id @default(uuid())
  quoteLineId       String?
  rfqLineId         String?
  productCode       String?
  grade             String?
  form              String?
  dimensions        Json?     // { thickness, width, length }
  quantity          Decimal
  unit              String    @default("LB")
  
  // Cost components
  materialCost      Decimal?
  processingCost    Decimal?
  laborCost         Decimal?
  freightCost       Decimal?
  yieldLossCost     Decimal?
  packagingCost     Decimal?
  overheadCost      Decimal?
  totalCost         Decimal?
  
  // Pricing output
  recommendedPrice  Decimal
  minimumPrice      Decimal?  // Floor based on margin
  listPrice         Decimal?
  marginPct         Decimal?
  confidenceScore   Decimal?  // 0-100
  
  // Context
  customerId        String?
  customerTier      String?
  locationId        String?
  inventorySource   String?   // Stock, Mill, Transfer
  leadTimeDays      Int?
  
  // Alternatives
  alternatives      Json?     // [{ type, price, leadTime, description }]
  
  // Model info
  pricingModel      String?   // V1, V2, etc.
  modelInputs       Json?     // Full inputs for audit
  createdAt         DateTime  @default(now())
}

// Pricing override record
model PricingOverride {
  id               String    @id @default(uuid())
  quoteLineId      String?
  quoteId          String?
  originalPrice    Decimal
  overridePrice    Decimal
  originalMargin   Decimal?
  overrideMargin   Decimal?
  reason           String
  justification    String?
  
  // Approval
  requestedById    String
  approvedById     String?
  approvalStatus   ApprovalStatus @default(PENDING)
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  
  // Audit
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

// Quote acceptance record
model QuoteAcceptance {
  id               String    @id @default(uuid())
  quoteId          String    @unique
  acceptedAt       DateTime  @default(now())
  acceptedBy       String?   // Customer contact name
  acceptedByEmail  String?
  customerPO       String?
  termsAccepted    Boolean   @default(true)
  signatureData    String?   // Base64 or URL
  ipAddress        String?
  notes            String?
  createdAt        DateTime  @default(now())
}

// RFQ source tracking
model RFQSource {
  id               String    @id @default(uuid())
  rfqId            String    @unique
  sourceType       RFQSourceType
  sourceChannel    String?   // Email, Phone, Portal, EDI
  rawContent       String?   // Original email body, etc.
  parsedData       Json?     // AI-parsed structure
  parsingConfidence Decimal? // 0-100
  parseErrors      Json?     // Any parsing issues
  receivedAt       DateTime  @default(now())
  processedAt      DateTime?
  createdAt        DateTime  @default(now())
}

// Pricing analytics snapshot
model PricingAnalytics {
  id               String    @id @default(uuid())
  period           String    // YYYY-MM or YYYY-WW
  customerId       String?
  productCategory  String?
  locationId       String?
  
  // Metrics
  quotesCreated    Int       @default(0)
  quotesWon        Int       @default(0)
  quotesLost       Int       @default(0)
  winRate          Decimal?
  avgMarginQuoted  Decimal?
  avgMarginWon     Decimal?
  avgResponseHours Decimal?
  avgCycleTimeDays Decimal?
  totalValueQuoted Decimal?
  totalValueWon    Decimal?
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@unique([period, customerId, productCategory, locationId])
}

enum RFQSourceType {
  EMAIL
  PHONE
  PORTAL
  EDI
  MANUAL
  ECOMMERCE
}
